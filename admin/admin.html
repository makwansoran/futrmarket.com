<!doctype html><meta charset="utf-8"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; font-src 'self' data:; connect-src 'self' http://localhost:8787 http://localhost:8788 http: https:;"><title>futrmarket administrator</title>
<style>
  body{background:#0b0f19;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Arial;margin:0}
  .wrap{max-width:1200px;margin:0 auto;padding:32px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:12px;padding:20px}
  h1{margin:0 0 16px;font-size:28px} h2{margin:0 0 12px;font-size:20px}
  input,select,textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #374151;background:#0f172a;color:#e5e7eb;box-sizing:border-box}
  label{font-size:14px;color:#93a3b8;margin-bottom:6px;display:block}
  button{background:#2563eb;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:14px}
  button:hover{background:#1d4ed8}
  button:disabled{background:#374151;cursor:not-allowed;opacity:0.5}
  .danger{background:#b91c1c}.danger:hover{background:#991b1b}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .mt8{margin-top:8px}.mt16{margin-top:16px}.mt24{margin-top:24px}
  .list-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid #1f2937;border-radius:8px;margin-bottom:12px;background:#0f172a;position:relative}
  .meta{color:#9ca3af;font-size:12px}.flex{display:flex;gap:8px;align-items:center}
  img.thumb{width:64px;height:40px;object-fit:cover;border-radius:6px;border:1px solid #1f2937}
  img.logo{width:48px;height:48px;object-fit:cover;border-radius:50%;border:2px solid #374151}
  .status-badge{position:absolute;top:8px;right:8px;padding:4px 10px;border-radius:4px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;z-index:10;box-shadow:0 2px 4px rgba(0,0,0,0.3)}
  .status-live{background:#dc2626;color:#fff}
  .status-upcoming{background:#fff;color:#000;border:1px solid #374151}
  .status-finished{background:#000;color:#fff}
  .status-cancelled{background:#6b7280;color:#fff}
  
  /* Tab Navigation */
  .tabs{display:flex;gap:8px;border-bottom:2px solid #1f2937;margin-bottom:24px;padding-bottom:0}
  .tab{background:transparent;border:none;padding:12px 24px;cursor:pointer;color:#9ca3af;border-bottom:2px solid transparent;margin-bottom:-2px;font-size:16px;font-weight:500}
  .tab:hover{color:#e5e7eb;background:#1f2937}
  .tab.active{color:#3b82f6;border-bottom-color:#3b82f6}
  .tab-content{display:none}
  .tab-content.active{display:block}
  
  /* Auth section always visible */
  .auth-section{margin-bottom:24px}
</style>
<div class="wrap">
  <h1>futrmarket administrator</h1>

  <div class="card auth-section">
    <h2>Auth & Connection</h2>
    <div class="row">
      <div><label>API URL</label><input id="apiUrl" placeholder="http://localhost:8787 or https://your-api.onrender.com"></div>
      <div><label>Admin Token</label><input id="token" placeholder="enter token"></div>
    </div>
    <div class="mt16 flex" style="gap:8px">
      <button id="saveToken">Save Settings</button>
      <button id="testConnection" style="background:#059669">Test Connection</button>
    </div>
    <div id="connectionStatus" class="mt8" style="display:none"></div>
    <div class="mt8 meta">
      <div><strong>Current API URL:</strong> <span id="currentApiUrl" style="color:#3b82f6">Loading...</span></div>
      <div class="mt4">API URL: Your backend server URL (local or deployed). Token is sent as <code>x-admin-token</code> header.</div>
      <div class="mt4" style="color:#f59e0b"><strong>Note:</strong> Image uploads use the admin server (localhost:8788). For production, you may need to configure image hosting separately.</div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tabs">
    <button class="tab active" data-tab="stats">Statistics</button>
    <button class="tab" data-tab="news">News</button>
    <button class="tab" data-tab="blog">Blog</button>
    <button class="tab" data-tab="contracts">Contracts</button>
    <button class="tab" data-tab="subjects">Subjects</button>
    <button class="tab" data-tab="features">Features</button>
    <button class="tab" data-tab="footer">Footer Content</button>
    <button class="tab" data-tab="accounts">Accounts</button>
  </div>

  <!-- Statistics Tab -->
  <div id="tab-stats" class="tab-content active">
    <div class="card">
      <div class="flex" style="justify-content:space-between;align-items:center;margin-bottom:16px">
        <h2>Platform Statistics</h2>
        <button id="refreshStats" style="background:#059669">Refresh</button>
      </div>
      <div id="statsContent">
        <div class="meta">Loading statistics...</div>
      </div>
    </div>
  </div>

  <!-- News Tab -->
  <div id="tab-news" class="tab-content">
    <div class="card">
      <h2>Create News Article</h2>
      <label>Title</label><input id="newsTitle" placeholder="News article title">
      <label class="mt16">Summary/Description</label><textarea id="newsSummary" placeholder="Brief summary of the news article..." style="min-height:80px;resize:vertical"></textarea>
      
      <div class="row mt16">
        <div><label>Article URL</label><input id="newsUrl" type="url" placeholder="https://example.com/article"></div>
        <div><label>Source (optional)</label><input id="newsSource" placeholder="CNN, Reuters, etc."></div>
      </div>

      <div class="row mt16">
        <div><label>Category</label>
          <select id="newsCategory">
            <option>News</option>
            <option>Politics</option>
            <option>Finance</option>
            <option>Crypto</option>
            <option>Economics</option>
            <option>Tech & Science</option>
            <option>World</option>
            <option>Culture</option>
          </select>
        </div>
        <div><label>Link to Contract (optional)</label>
          <select id="newsContractId">
            <option value="">None</option>
          </select>
        </div>
      </div>

      <div class="mt16">
        <label>Image (optional)</label>
        <input id="newsImg" type="file" accept="image/*">
        <div id="newsPreview" class="mt8"></div>
      </div>

      <div class="mt16"><button id="createNews">Create News Article</button></div>
      <div class="mt8 meta">Create a news article that can be linked to a contract. Users can read the article and see related markets.</div>
    </div>

    <div class="card mt16">
      <h2>Existing News Articles</h2>
      <div id="newsList"></div>
      <div class="mt8 meta">Published news articles.</div>
    </div>
  </div>

  <!-- Blog Tab -->
  <div id="tab-blog" class="tab-content">
    <div class="card">
      <h2>Create Blog Post</h2>
      <label>Title</label><input id="blogTitle" placeholder="Blog post title">
      <label class="mt16">Excerpt/Summary</label><textarea id="blogExcerpt" placeholder="Brief summary that appears in the blog list..." style="min-height:80px;resize:vertical"></textarea>
      <label class="mt16">Content</label><textarea id="blogContent" placeholder="Full blog post content (supports markdown)..." style="min-height:200px;resize:vertical"></textarea>
      
      <div class="row mt16">
        <div><label>Author</label><input id="blogAuthor" placeholder="FutrMarket Team" value="FutrMarket Team"></div>
        <div><label>Category</label>
          <select id="blogCategory">
            <option>Announcements</option>
            <option>Tutorial</option>
            <option>Education</option>
            <option>News</option>
            <option>General</option>
          </select>
        </div>
      </div>

      <div class="row mt16">
        <div><label>Published</label>
          <select id="blogPublished">
            <option value="true">Yes</option>
            <option value="false">No (Draft)</option>
          </select>
        </div>
        <div></div>
      </div>

      <div class="mt16">
        <label>Featured Image (optional)</label>
        <input id="blogImg" type="file" accept="image/*">
        <div id="blogPreview" class="mt8"></div>
      </div>

      <div class="mt16"><button id="createBlog">Create Blog Post</button></div>
      <div class="mt8 meta">Create a blog post that appears on the /blog page. Content supports markdown formatting.</div>
    </div>

    <div class="card mt16">
      <h2>Existing Blog Posts</h2>
      <div id="blogList"></div>
      <div class="mt8 meta">Published and draft blog posts.</div>
    </div>
  </div>

  <!-- Contracts Tab -->
  <div id="tab-contracts" class="tab-content">
    <div class="card">
      <h2>Create Contract</h2>
      <label>Question</label><input id="contractQ" placeholder="Will BTC hit $100k in 2025?">
      <label class="mt16">Description (optional)</label><textarea id="contractDesc" placeholder="Additional details about this contract..." style="min-height:80px;resize:vertical"></textarea>

      <div class="row mt16">
        <div><label>Category</label>
          <select id="contractCat">
            <option>Politics</option>
            <option>Crypto</option>
            <option>Economics</option>
            <option>Mentions</option>
            <option>Companies</option>
            <option>Financials</option>
            <option>Tech & Science</option>
            <option>General</option>
          </select>
          <div class="mt4 meta">Select a category to appear on homepage. Categories: Politics, Crypto, Economics, Mentions, Companies, Financials, Tech & Science</div>
        </div>
        <div><label>Expiration Date</label><input id="contractExp" type="date"></div>
      </div>

      <div class="mt16">
        <label>Subject (optional)</label>
        <select id="contractSubjectId">
          <option value="">None</option>
        </select>
        <div class="mt4 meta">Link this contract to a subject (e.g., Epstein, Trump, Bitcoin). Subjects appear in navigation.</div>
      </div>

      <div class="mt16" style="border: 2px dashed #4b5563; padding: 16px; border-radius: 8px; background: #1f2937;">
        <label style="font-weight: bold; color: #60a5fa; display: block; margin-bottom: 8px;">ðŸ“· Contract Profile Picture</label>
        <div class="meta" style="margin-bottom: 12px; color: #9ca3af;">Upload an image that will appear as a small square profile picture in the upper left corner of each contract card (like Polymarket/Kalshi)</div>
        <input id="contractImg" type="file" accept="image/*" style="width: 100%; padding: 8px; background: #111827; border: 1px solid #374151; border-radius: 4px; color: white;">
        <div id="contractPreview" class="mt8" style="display: flex; align-items: center; gap: 12px;">
          <div class="meta" style="color: #6b7280;">Preview will appear here</div>
        </div>
      </div>

      <div class="mt16"><button id="createContract">Create Contract</button></div>
      <div class="mt8 meta">Creates a new tradeable contract. Prices start at $1 and adjust based on trading activity.</div>
    </div>

    <div class="card mt16">
      <h2>Existing Contracts</h2>
      <div class="mt8">
        <button id="cleanupDuplicates" class="danger" style="margin-bottom: 8px;">Remove Duplicate Contracts</button>
        <div class="meta">Removes duplicate contracts with the same question (keeps the oldest one).</div>
      </div>
      <div id="contractList" class="mt16"></div>
      <div class="mt8 meta">Tradeable contracts with AMM pricing.</div>
    </div>
  </div>

  <!-- Features Tab -->
  <div id="tab-features" class="tab-content">
    <div class="card">
      <h2>Create Feature</h2>
      <label>Title</label><input id="featureTitle" placeholder="Campaign or feature title">
      <label class="mt16">Description</label><textarea id="featureDesc" placeholder="Description of the feature, campaign, or design..." style="min-height:100px;resize:vertical"></textarea>
      
      <div class="row mt16">
        <div><label>Type</label>
          <select id="featureType">
            <option>Campaign</option>
            <option>Design</option>
            <option>Promotion</option>
            <option>Announcement</option>
          </select>
        </div>
        <div><label>Status</label>
          <select id="featureStatus">
            <option>Draft</option>
            <option>Active</option>
            <option>Paused</option>
            <option>Completed</option>
          </select>
        </div>
      </div>

      <div class="mt16">
        <label>Image (optional)</label>
        <input id="featureImg" type="file" accept="image/*">
        <div id="featurePreview" class="mt8"></div>
      </div>

      <div class="mt16">
        <label>Link URL (optional)</label>
        <input id="featureUrl" type="url" placeholder="https://example.com">
      </div>

      <div class="mt16">
        <label>Subject (optional - links feature card to subject page)</label>
        <select id="featureSubjectId">
          <option value="">None</option>
        </select>
      </div>

      <div class="mt16"><button id="createFeature">Create Feature</button></div>
      <div class="mt8 meta">Create campaigns, designs, promotions, and other features for the website.</div>
    </div>

    <div class="card mt16">
      <h2>Existing Features</h2>
      <div id="featureList"></div>
      <div class="mt8 meta">All created features, campaigns, and designs.</div>
    </div>
  </div>

  <!-- Subjects Tab -->
  <div id="tab-subjects" class="tab-content">
    <div class="card">
      <h2>Create Subject</h2>
      <label>Subject Name</label>
      <input id="subjectName" placeholder="e.g., Epstein, Trump, Bitcoin, etc.">
      <label class="mt16">Description (optional)</label>
      <textarea id="subjectDesc" placeholder="Brief description of this subject..." style="min-height:80px;resize:vertical"></textarea>
      <div class="mt16"><button id="createSubject">Create Subject</button></div>
      <div class="mt8 meta">Create subjects to organize contracts around specific events or topics. Subjects appear in navigation and on feature cards.</div>
    </div>

    <div class="card mt16">
      <h2>Existing Subjects</h2>
      <div id="subjectsList"></div>
      <div class="mt8 meta">All subjects. These will appear in the subjects navigation bar.</div>
    </div>
  </div>

  <!-- Footer Content Tab -->
  <div id="tab-footer" class="tab-content">
    <div class="card">
      <h2>Create Footer Content</h2>
      <label>Content Type</label>
      <select id="footerContentType">
        <option value="blog">Blog</option>
        <option value="careers">Careers</option>
        <option value="privacy">Privacy Policy</option>
        <option value="data-terms">Data Terms of Service</option>
        <option value="company">Company</option>
        <option value="brand-kit">Brand Kit</option>
        <option value="become-a-partner">Become A Partner</option>
        <option value="help">Help Center</option>
        <option value="api">API</option>
        <option value="faq-finance">FAQ for Finance Professionals</option>
        <option value="regulatory">Regulatory</option>
        <option value="trading-hours">Trading Hours</option>
        <option value="fee-schedule">Fee Schedule</option>
        <option value="trading-prohibitions">Trading Prohibitions</option>
        <option value="incentive-program">Incentive Program</option>
      </select>
      
      <label class="mt16">Title</label>
      <input id="footerContentTitle" placeholder="Content title">
      
      <label class="mt16">Content</label>
      <textarea id="footerContentBody" placeholder="Enter the content here..." style="min-height:200px;resize:vertical"></textarea>
      
      <div class="row mt16">
        <div><label>Author (optional)</label><input id="footerContentAuthor" placeholder="Author name"></div>
        <div><label>Published Date</label><input id="footerContentDate" type="date"></div>
      </div>

      <div class="mt16">
        <label>Image (optional)</label>
        <input id="footerContentImg" type="file" accept="image/*">
        <div id="footerContentPreview" class="mt8"></div>
      </div>

      <div class="mt16"><button id="createFooterContent">Create Footer Content</button></div>
      <div class="mt8 meta">Create content for footer links. This content will be displayed when users click on footer links.</div>
    </div>

    <div class="card mt16">
      <h2>Existing Footer Content</h2>
      <div id="footerContentList"></div>
      <div class="mt8 meta">All footer content items.</div>
    </div>
  </div>

  <!-- Accounts Tab -->
  <div id="tab-accounts" class="tab-content">
    <div class="card">
      <h2>User Accounts</h2>
      <div id="accountsList"></div>
      <div class="mt8 meta">All registered user accounts with balances and account information.</div>
    </div>
  </div>
</div>

<script>
(function(){
  // Tab switching
  var tabs = document.querySelectorAll(".tab");
  var tabContents = document.querySelectorAll(".tab-content");
  tabs.forEach(function(tab){
    tab.onclick = function(){
      var targetTab = tab.getAttribute("data-tab");
      tabs.forEach(function(t){t.classList.remove("active")});
      tabContents.forEach(function(tc){tc.classList.remove("active")});
      tab.classList.add("active");
      document.getElementById("tab-"+targetTab).classList.add("active");
      
      // Load data when switching tabs
      if(targetTab === "stats") loadStats();
      else if(targetTab === "accounts") loadAccounts();
      else if(targetTab === "contracts") loadContracts();
      else if(targetTab === "news") loadNews();
      else if(targetTab === "blog") loadBlog();
      else if(targetTab === "features") loadFeatures();
      else if(targetTab === "subjects") loadSubjects();
      else if(targetTab === "footer") loadFooterContent();
    };
  });

  // Auth
  var tokenBox=document.getElementById("token"),apiUrlBox=document.getElementById("apiUrl"),saveBtn=document.getElementById("saveToken");
  function getT(){
    var token = localStorage.getItem("fb_admin_token");
    if (!token) {
      token = "changeme";
      setT(token);
    }
    return token;
  }
  function setT(v){localStorage.setItem("fb_admin_token",v||"changeme")}
  function getApiUrl(){
    var url = localStorage.getItem("fb_admin_api_url");
    if (!url) {
      url = "http://localhost:8787";
      setApiUrl(url);
    }
    return url.replace(/\/+$/, ""); // Remove trailing slashes
  }
  function setApiUrl(v){localStorage.setItem("fb_admin_api_url",v||"http://localhost:8787")}
  function apiEndpoint(endpoint){
    var base = getApiUrl();
    var cleanEndpoint = endpoint.startsWith("/") ? endpoint : "/" + endpoint;
    return base + cleanEndpoint;
  }
  var currentApiUrlSpan = document.getElementById("currentApiUrl");
  var connectionStatus = document.getElementById("connectionStatus");
  var testConnectionBtn = document.getElementById("testConnection");
  
  function updateCurrentApiUrl() {
    currentApiUrlSpan.textContent = getApiUrl();
  }
  
  async function testConnection() {
    var url = getApiUrl();
    var token = getT();
    if (!url || !token) {
      connectionStatus.innerHTML = "<div style='color:#ef4444'>Please set API URL and token first</div>";
      connectionStatus.style.display = "block";
      return;
    }
    
    testConnectionBtn.disabled = true;
    testConnectionBtn.textContent = "Testing...";
    connectionStatus.innerHTML = "<div style='color:#9ca3af'>Testing connection to " + url + "...</div>";
    connectionStatus.style.display = "block";
    
    try {
      // Test endpoint doesn't require auth, but we'll test with auth too
      var r = await fetch(apiEndpoint("/api/test"), {
        method: "GET"
      });
      
      if (r.ok) {
        var j = await r.json().catch(() => ({}));
        connectionStatus.innerHTML = "<div style='color:#10b981'><strong>âœ“ Connected!</strong> Server is responding.</div>";
      } else if (r.status === 401) {
        connectionStatus.innerHTML = "<div style='color:#ef4444'><strong>âœ— Unauthorized</strong> Check your admin token.</div>";
      } else {
        connectionStatus.innerHTML = "<div style='color:#f59e0b'><strong>âš  Server responded</strong> but with status " + r.status + ". Check if the API URL is correct.</div>";
      }
    } catch (e) {
      connectionStatus.innerHTML = "<div style='color:#ef4444'><strong>âœ— Connection failed</strong> " + e.message + ". Make sure the API URL is correct and the server is running.</div>";
    } finally {
      testConnectionBtn.disabled = false;
      testConnectionBtn.textContent = "Test Connection";
    }
  }
  
  saveBtn.onclick=function(){ 
    setT(tokenBox.value||""); 
    setApiUrl(apiUrlBox.value||"http://localhost:8787");
    updateCurrentApiUrl();
    alert("Settings saved! Test the connection to verify it works."); 
  };
  
  testConnectionBtn.onclick = testConnection;
  
  tokenBox.value=getT()||"changeme";
  apiUrlBox.value=getApiUrl()||"http://localhost:8787";
  updateCurrentApiUrl();
  
  if(!localStorage.getItem("fb_admin_token")){
    setT("changeme");
    tokenBox.value="changeme";
  }
  if(!localStorage.getItem("fb_admin_api_url")){
    setApiUrl("http://localhost:8787");
    apiUrlBox.value="http://localhost:8787";
    updateCurrentApiUrl();
  }
  
  // Update current URL display when input changes
  apiUrlBox.addEventListener("input", updateCurrentApiUrl);

  // News elements
  var newsTitle=document.getElementById("newsTitle"),newsSummary=document.getElementById("newsSummary"),
      newsUrl=document.getElementById("newsUrl"),newsSource=document.getElementById("newsSource"),
      newsCategory=document.getElementById("newsCategory"),newsContractId=document.getElementById("newsContractId"),
      newsImg=document.getElementById("newsImg"),newsPreview=document.getElementById("newsPreview"),
      createNewsBtn=document.getElementById("createNews"),newsList=document.getElementById("newsList");

  newsImg.onchange = function(){
    newsPreview.innerHTML = "";
    if (newsImg.files && newsImg.files[0]) {
      var url = URL.createObjectURL(newsImg.files[0]);
      var el = document.createElement("img");
      el.src = url; el.className = "thumb";
      newsPreview.appendChild(el);
    }
  };

  function newsRow(n){
    var w=document.createElement("div"); w.className="list-item";
    var L=document.createElement("div");
    var top=document.createElement("div"); top.style.display="flex"; top.style.gap="10px"; top.style.alignItems="center";
    if (n.imageUrl) { var im=document.createElement("img"); im.src=n.imageUrl; im.className="thumb"; top.appendChild(im); }
    var title=document.createElement("div"); title.textContent=n.title; top.appendChild(title);
    var meta=document.createElement("div"); meta.className="meta";
    meta.textContent=(n.category||"News")+" Â· "+(n.source||"Unknown source")+(n.contractId ? " Â· Linked to contract" : "");
    L.appendChild(top); L.appendChild(meta);

    var R=document.createElement("div"); R.className="flex";
    var editBtn=document.createElement("button"); editBtn.textContent="Edit"; editBtn.style.marginRight="4px";
    editBtn.onclick=function(){editNews(n)};
    var del=document.createElement("button"); del.className="danger"; del.textContent="Delete";
    del.onclick=function(){removeNews(n.id)};
    R.appendChild(editBtn); R.appendChild(del);

    w.appendChild(L); w.appendChild(R); return w;
  }

  // Statistics elements
  var statsContent=document.getElementById("statsContent"),refreshStatsBtn=document.getElementById("refreshStats");

  async function loadStats(){
    try{
      var token = getT();
      if (!token) {
        statsContent.innerHTML="<div class='meta' style='color:#ef4444'>Please set admin token first</div>";
        return;
      }
      
      var r=await fetch(apiEndpoint("/api/stats"),{headers:{"x-admin-token":token}});
      if(!r.ok){
        if(r.status === 401){
          statsContent.innerHTML="<div class='meta' style='color:#ef4444'>Unauthorized. Check your admin token (default: 'changeme')</div>";
        }else{
          statsContent.innerHTML="<div class='meta'>Failed to load statistics: "+r.status+"</div>";
        }
        return;
      }
      
      var j=await r.json();
      if(!j.ok){
        statsContent.innerHTML="<div class='meta'>Failed: "+(j.error||"unknown")+"</div>";
        return;
      }
      
      var stats = j.data;
      var html = "<div style='display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:16px;margin-top:16px'>";
      
      // Contracts Stats
      html += "<div style='background:#0f172a;border:1px solid #1f2937;border-radius:8px;padding:16px'>";
      html += "<h3 style='margin:0 0 12px;font-size:18px;color:#3b82f6'>Contracts</h3>";
      html += "<div style='font-size:32px;font-weight:bold;color:#fff;margin-bottom:8px'>"+stats.contracts.total+"</div>";
      html += "<div class='meta' style='margin-top:8px'>";
      html += "<div>Active: <strong>"+stats.contracts.active+"</strong></div>";
      html += "<div>Resolved: <strong>"+stats.contracts.resolved+"</strong></div>";
      html += "<div>Total Volume: <strong>$"+stats.contracts.totalVolume.toFixed(2)+"</strong></div>";
      html += "</div></div>";
      
      // News Stats
      html += "<div style='background:#0f172a;border:1px solid #1f2937;border-radius:8px;padding:16px'>";
      html += "<h3 style='margin:0 0 12px;font-size:18px;color:#3b82f6'>News Articles</h3>";
      html += "<div style='font-size:32px;font-weight:bold;color:#fff;margin-bottom:8px'>"+stats.news.total+"</div>";
      html += "<div class='meta' style='margin-top:8px'>Total published articles</div>";
      html += "</div>";
      
      // Orders/Bets Stats
      html += "<div style='background:#0f172a;border:1px solid #1f2937;border-radius:8px;padding:16px'>";
      html += "<h3 style='margin:0 0 12px;font-size:18px;color:#3b82f6'>Bets/Orders</h3>";
      html += "<div style='font-size:32px;font-weight:bold;color:#fff;margin-bottom:8px'>"+stats.orders.total+"</div>";
      html += "<div class='meta' style='margin-top:8px'>";
      html += "<div>Buy Orders: <strong>"+stats.orders.buy+"</strong></div>";
      html += "<div>Sell Orders: <strong>"+stats.orders.sell+"</strong></div>";
      html += "<div>Total Volume: <strong>$"+stats.orders.totalVolume.toFixed(2)+"</strong></div>";
      html += "</div></div>";
      
      // Users Stats
      html += "<div style='background:#0f172a;border:1px solid #1f2937;border-radius:8px;padding:16px'>";
      html += "<h3 style='margin:0 0 12px;font-size:18px;color:#3b82f6'>Users</h3>";
      html += "<div style='font-size:32px;font-weight:bold;color:#fff;margin-bottom:8px'>"+stats.users.total+"</div>";
      html += "<div class='meta' style='margin-top:8px'>";
      html += "<div>Total Users: <strong>"+stats.users.total+"</strong></div>";
      html += "<div>Online Users: <strong style='color:#10b981'>"+stats.users.online+"</strong> <span style='color:#6b7280;font-size:11px'>(last 5 min)</span></div>";
      html += "<div>With Positions: <strong>"+stats.users.withPositions+"</strong></div>";
      html += "</div></div>";
      
      // Ideas Stats
      html += "<div style='background:#0f172a;border:1px solid #1f2937;border-radius:8px;padding:16px'>";
      html += "<h3 style='margin:0 0 12px;font-size:18px;color:#3b82f6'>Forum Ideas</h3>";
      html += "<div style='font-size:32px;font-weight:bold;color:#fff;margin-bottom:8px'>"+stats.ideas.total+"</div>";
      html += "<div class='meta' style='margin-top:8px'>User-submitted ideas</div>";
      html += "</div>";
      
      html += "</div>";
      statsContent.innerHTML = html;
    }catch(e){
      statsContent.innerHTML="<div class='meta' style='color:#ef4444'>Failed to load statistics: "+e.message+"</div>";
    }
  }

  if(refreshStatsBtn) refreshStatsBtn.onclick=function(){loadStats();};

  async function loadNews(){
    var token = getT();
    if (!token) {
      newsList.innerHTML="<div class='meta' style='color:#ef4444'>Please set admin token first</div>";
      return;
    }
    var r=await fetch(apiEndpoint("/api/news"),{headers:{"x-admin-token":token}});
    if(!r.ok){
      if(r.status===401){
        newsList.innerHTML="<div class='meta' style='color:#ef4444'>Unauthorized. Check your admin token (default: 'changeme')</div>";
      }else{
        newsList.innerHTML="<div class='meta'>Failed to load news: "+r.status+"</div>";
      }
      return;
    }
    var j=await r.json(); if(!j.ok){newsList.innerHTML="<div class='meta'>Failed: "+(j.error||"unknown")+"</div>";return}
    newsList.innerHTML="";
    if(!j.data||!j.data.length){ var e=document.createElement("div");e.className="meta";e.textContent="No news articles yet.";newsList.appendChild(e);return;}
    for(var i=0;i<j.data.length;i++) newsList.appendChild(newsRow(j.data[i]));
    
    // Populate contract dropdown
    newsContractId.innerHTML = "<option value=''>None</option>";
    var contractR = await fetch(apiEndpoint("/api/contracts"),{headers:{"x-admin-token":token}});
    if(contractR.ok){
      var contractJ = await contractR.json();
      if(contractJ.ok && contractJ.data && contractJ.data.length){
        for(var i=0;i<contractJ.data.length;i++){
          var opt = document.createElement("option");
          opt.value = contractJ.data[i].id;
          opt.textContent = contractJ.data[i].question;
          newsContractId.appendChild(opt);
        }
      }
    }
  }

  async function uploadNewsImage(){
    if (!newsImg.files || !newsImg.files[0]) return null;
    var fd = new FormData();
    fd.append("image", newsImg.files[0]);
    var r = await fetch(apiEndpoint("/api/upload"),{ method:"POST", headers:{ "x-admin-token":getT() }, body: fd });
    if (!r.ok) { throw new Error("Upload failed: "+r.status); }
    var j = await r.json();
    if (!j.ok) { throw new Error("Upload failed: "+(j.error||"unknown")); }
    return j.url;
  }

  async function createNews(){
    try{
      var token = getT();
      if (!token) {
        alert("Please set admin token first (default: 'changeme')");
        return;
      }
      token = String(token).trim();
      if(!newsTitle.value.trim()){alert("Title required");return}
      if(!newsSummary.value.trim()){alert("Summary required");return}
      if(!newsUrl.value.trim()){alert("Article URL required");return}
      
      var imageUrl = await uploadNewsImage();
      var payload = { 
        title: newsTitle.value.trim(), 
        summary: newsSummary.value.trim(), 
        url: newsUrl.value.trim(),
        source: newsSource.value.trim() || null,
        category: newsCategory.value, 
        contractId: newsContractId.value || null,
        imageUrl: imageUrl 
      };
      
      var r=await fetch(apiEndpoint("/api/news"),{ 
        method:"POST", 
        headers: { "Content-Type":"application/json","x-admin-token":token }, 
        body: JSON.stringify(payload) 
      });
      if(!r.ok){
        if(r.status===401){
          alert("Unauthorized. Check your admin token (default: 'changeme')");
        }else{
          var j = await r.json().catch(()=>({}));
          alert("Create failed: "+(j.error||r.status));
        }
        return;
      }
      var j=await r.json(); if(!j.ok){alert("Create failed: "+(j.error||"unknown")+"</div>");return}
      newsTitle.value=""; newsSummary.value=""; newsUrl.value=""; newsSource.value=""; 
      newsCategory.value="News"; newsContractId.value=""; newsImg.value=""; newsPreview.innerHTML="";
      loadNews();
      alert("News article created successfully!\n\nCreated on: " + getApiUrl() + "\n\nRefresh your website to see it.");
    }catch(e){ alert(e.message || "Could not create news article"); }
  }

  function editNews(n){
    newsTitle.value=n.title||"";
    newsSummary.value=n.summary||"";
    newsUrl.value=n.url||"";
    newsSource.value=n.source||"";
    newsCategory.value=n.category||"News";
    newsContractId.value=n.contractId||"";
    newsImg.value="";
    newsPreview.innerHTML="";
    if(n.imageUrl){
      var img=document.createElement("img");
      img.src=n.imageUrl;
      img.className="thumb";
      newsPreview.appendChild(img);
    }
    
    var btn=createNewsBtn;
    var originalText=btn.textContent;
    btn.textContent="Update News Article";
    btn.onclick=function(){
      updateNews(n.id);
      btn.textContent=originalText;
      btn.onclick=function(){createNews();};
    };
    
    document.querySelector("#newsTitle").scrollIntoView({behavior:"smooth",block:"center"});
  }

  async function updateNews(id){
    try{
      var token = getT();
      if (!token) {
        alert("Please set admin token first (default: 'changeme')");
        return;
      }
      token = String(token).trim();
      if(!newsTitle.value.trim()){alert("Title required");return}
      if(!newsSummary.value.trim()){alert("Summary required");return}
      if(!newsUrl.value.trim()){alert("Article URL required");return}
      
      var imageUrl = await uploadNewsImage();
      var payload = { 
        title: newsTitle.value.trim(), 
        summary: newsSummary.value.trim(), 
        url: newsUrl.value.trim(),
        source: newsSource.value.trim() || null,
        category: newsCategory.value, 
        contractId: newsContractId.value || null
      };
      if(imageUrl) payload.imageUrl = imageUrl;
      
      var r=await fetch(apiEndpoint("/api/news/"+encodeURIComponent(id)),{ 
        method:"PATCH", 
        headers: { "Content-Type":"application/json","x-admin-token":token }, 
        body: JSON.stringify(payload) 
      });
      if(!r.ok){
        var j = await r.json().catch(()=>({}));
        if(r.status===401){
          alert("Unauthorized. Check your admin token (default: 'changeme')");
        }else{
          alert("Update failed: "+(j.error||r.status));
        }
        return;
      }
      var j=await r.json(); if(!j.ok){alert("Update failed: "+(j.error||"unknown"));return}
      newsTitle.value=""; newsSummary.value=""; newsUrl.value=""; newsSource.value=""; 
      newsCategory.value="News"; newsContractId.value=""; newsImg.value=""; newsPreview.innerHTML="";
      loadNews();
      alert("News article updated!");
    }catch(e){ alert(e.message || "Could not update news article"); }
  }

  async function removeNews(id){
    if (!confirm("Delete news article "+id+"? This cannot be undone.")) return;
    var token = getT();
    var r=await fetch(apiEndpoint("/api/news/"+encodeURIComponent(id)),{ 
      method:"DELETE", 
      headers:{ "x-admin-token":token }
    });
    if(!r.ok){
      var j = await r.json().catch(()=>({}));
      alert("Delete failed: "+(j.error||r.status));
      return;
    }
    loadNews();
    alert("News article deleted!");
  }

  // Blog elements
  var blogTitle=document.getElementById("blogTitle"),blogExcerpt=document.getElementById("blogExcerpt"),
      blogContent=document.getElementById("blogContent"),blogAuthor=document.getElementById("blogAuthor"),
      blogCategory=document.getElementById("blogCategory"),blogPublished=document.getElementById("blogPublished"),
      blogImg=document.getElementById("blogImg"),blogPreview=document.getElementById("blogPreview"),
      createBlogBtn=document.getElementById("createBlog"),blogList=document.getElementById("blogList");

  blogImg.onchange = function(){
    blogPreview.innerHTML = "";
    if (blogImg.files && blogImg.files[0]) {
      var url = URL.createObjectURL(blogImg.files[0]);
      var el = document.createElement("img");
      el.src = url; el.className = "thumb";
      blogPreview.appendChild(el);
    }
  };

  function blogRow(b){
    var w=document.createElement("div"); w.className="list-item";
    var L=document.createElement("div");
    var top=document.createElement("div"); top.style.display="flex"; top.style.gap="10px"; top.style.alignItems="center";
    if (b.imageUrl) { var im=document.createElement("img"); im.src=b.imageUrl; im.className="thumb"; top.appendChild(im); }
    var title=document.createElement("div"); title.textContent=b.title; top.appendChild(title);
    var meta=document.createElement("div"); meta.className="meta";
    var status = b.published ? "Published" : "Draft";
    meta.textContent=(b.category||"General")+" Â· "+b.author+" Â· "+status+" Â· "+new Date(b.createdAt||Date.now()).toLocaleDateString();
    L.appendChild(top); L.appendChild(meta);

    var R=document.createElement("div"); R.className="flex";
    var editBtn=document.createElement("button"); editBtn.textContent="Edit"; editBtn.style.marginRight="4px";
    editBtn.onclick=function(){editBlog(b)};
    var del=document.createElement("button"); del.className="danger"; del.textContent="Delete";
    del.onclick=function(){removeBlog(b.id)};
    R.appendChild(editBtn); R.appendChild(del);

    w.appendChild(L); w.appendChild(R); return w;
  }

  async function loadBlog(){
    var token = getT();
    if (!token) {
      blogList.innerHTML="<div class='meta' style='color:#ef4444'>Please set admin token first</div>";
      return;
    }
    var r=await fetch(apiEndpoint("/api/blog"),{headers:{"x-admin-token":token}});
    if(!r.ok){
      if(r.status===401){
        blogList.innerHTML="<div class='meta' style='color:#ef4444'>Unauthorized. Check your admin token (default: 'changeme')</div>";
      }else{
        blogList.innerHTML="<div class='meta'>Failed to load blog posts: "+r.status+"</div>";
      }
      return;
    }
    var j=await r.json(); if(!j.ok){blogList.innerHTML="<div class='meta'>Failed: "+(j.error||"unknown")+"</div>";return}
    blogList.innerHTML="";
    if(!j.data||!j.data.length){ var e=document.createElement("div");e.className="meta";e.textContent="No blog posts yet.";blogList.appendChild(e);return;}
    for(var i=0;i<j.data.length;i++) blogList.appendChild(blogRow(j.data[i]));
  }

  async function uploadBlogImage(){
    if (!blogImg.files || !blogImg.files[0]) return null;
    var fd = new FormData();
    fd.append("image", blogImg.files[0]);
    var r = await fetch(apiEndpoint("/api/upload"),{ method:"POST", headers:{ "x-admin-token":getT() }, body: fd });
    if (!r.ok) { throw new Error("Upload failed: "+r.status); }
    var j = await r.json();
    if (!j.ok) { throw new Error("Upload failed: "+(j.error||"unknown")); }
    return j.url;
  }

  async function createBlog(){
    try{
      var token = getT();
      if (!token) {
        alert("Please set admin token first (default: 'changeme')");
        return;
      }
      token = String(token).trim();
      if(!blogTitle.value.trim()){alert("Title required");return}
      if(!blogExcerpt.value.trim()){alert("Excerpt required");return}
      if(!blogContent.value.trim()){alert("Content required");return}
      
      var imageUrl = await uploadBlogImage();
      var payload = { 
        title: blogTitle.value.trim(), 
        excerpt: blogExcerpt.value.trim(), 
        content: blogContent.value.trim(),
        author: blogAuthor.value.trim() || "FutrMarket Team",
        category: blogCategory.value, 
        published: blogPublished.value === "true",
        imageUrl: imageUrl 
      };
      
      var r=await fetch(apiEndpoint("/api/blog"),{ 
        method:"POST", 
        headers: { "Content-Type":"application/json","x-admin-token":token }, 
        body: JSON.stringify(payload) 
      });
      if(!r.ok){
        if(r.status===401){
          alert("Unauthorized. Check your admin token (default: 'changeme')");
        }else{
          var j = await r.json().catch(()=>({}));
          alert("Create failed: "+(j.error||r.status));
        }
        return;
      }
      var j=await r.json(); if(!j.ok){alert("Create failed: "+(j.error||"unknown"));return}
      blogTitle.value=""; blogExcerpt.value=""; blogContent.value=""; blogAuthor.value="FutrMarket Team"; 
      blogCategory.value="Announcements"; blogPublished.value="true"; blogImg.value=""; blogPreview.innerHTML="";
      loadBlog();
      alert("Blog post created successfully!");
    }catch(e){ alert(e.message || "Could not create blog post"); }
  }

  function editBlog(b){
    blogTitle.value=b.title||"";
    blogExcerpt.value=b.excerpt||"";
    blogContent.value=b.content||"";
    blogAuthor.value=b.author||"FutrMarket Team";
    blogCategory.value=b.category||"Announcements";
    blogPublished.value=b.published ? "true" : "false";
    blogImg.value="";
    blogPreview.innerHTML="";
    if(b.imageUrl){
      var img=document.createElement("img");
      img.src=b.imageUrl;
      img.className="thumb";
      blogPreview.appendChild(img);
    }
    
    var btn=createBlogBtn;
    var originalText=btn.textContent;
    btn.textContent="Update Blog Post";
    btn.onclick=function(){
      updateBlog(b.id);
      btn.textContent=originalText;
      btn.onclick=function(){createBlog();};
    };
    
    document.querySelector("#blogTitle").scrollIntoView({behavior:"smooth",block:"center"});
  }

  async function updateBlog(id){
    try{
      var token = getT();
      if (!token) {
        alert("Please set admin token first (default: 'changeme')");
        return;
      }
      token = String(token).trim();
      if(!blogTitle.value.trim()){alert("Title required");return}
      if(!blogExcerpt.value.trim()){alert("Excerpt required");return}
      if(!blogContent.value.trim()){alert("Content required");return}
      
      var imageUrl = await uploadBlogImage();
      var payload = { 
        title: blogTitle.value.trim(), 
        excerpt: blogExcerpt.value.trim(), 
        content: blogContent.value.trim(),
        author: blogAuthor.value.trim() || "FutrMarket Team",
        category: blogCategory.value, 
        published: blogPublished.value === "true"
      };
      if(imageUrl) payload.imageUrl = imageUrl;
      
      var r=await fetch(apiEndpoint("/api/blog/"+encodeURIComponent(id)),{ 
        method:"PATCH", 
        headers: { "Content-Type":"application/json","x-admin-token":token }, 
        body: JSON.stringify(payload) 
      });
      if(!r.ok){
        var j = await r.json().catch(()=>({}));
        alert("Update failed: "+(j.error||r.status));
        return;
      }
      var j=await r.json(); if(!j.ok){alert("Update failed: "+(j.error||"unknown"));return}
      blogTitle.value=""; blogExcerpt.value=""; blogContent.value=""; blogAuthor.value="FutrMarket Team"; 
      blogCategory.value="Announcements"; blogPublished.value="true"; blogImg.value=""; blogPreview.innerHTML="";
      loadBlog();
      alert("Blog post updated!");
    }catch(e){ alert(e.message || "Could not update blog post"); }
  }

  async function removeBlog(id){
    if (!confirm("Delete blog post "+id+"? This cannot be undone.")) return;
    var token = getT();
    var r=await fetch(apiEndpoint("/api/blog/"+encodeURIComponent(id)),{ 
      method:"DELETE", 
      headers:{ "x-admin-token":token }
    });
    if(!r.ok){
      var j = await r.json().catch(()=>({}));
      alert("Delete failed: "+(j.error||r.status));
      return;
    }
    loadBlog();
    alert("Blog post deleted!");
  }

  // Contracts elements
  var contractQ=document.getElementById("contractQ"),contractDesc=document.getElementById("contractDesc"),
      contractCat=document.getElementById("contractCat"),contractExp=document.getElementById("contractExp"),
      contractSubjectId=document.getElementById("contractSubjectId"),
      contractImg=document.getElementById("contractImg"),contractPreview=document.getElementById("contractPreview"),
      createContractBtn=document.getElementById("createContract"),contractList=document.getElementById("contractList");

  contractImg.onchange = function(){
    contractPreview.innerHTML = "";
    if (contractImg.files && contractImg.files[0]) {
      var url = URL.createObjectURL(contractImg.files[0]);
      var container = document.createElement("div");
      container.style.display = "flex";
      container.style.alignItems = "center";
      container.style.gap = "12px";
      
      var previewLabel = document.createElement("div");
      previewLabel.className = "meta";
      previewLabel.style.color = "#60a5fa";
      previewLabel.textContent = "Preview (will appear as square profile picture):";
      container.appendChild(previewLabel);
      
      var el = document.createElement("img");
      el.src = url;
      el.style.width = "64px";
      el.style.height = "64px";
      el.style.borderRadius = "8px";
      el.style.objectFit = "cover";
      el.style.border = "2px solid #4b5563";
      el.style.display = "block";
      container.appendChild(el);
      
      contractPreview.appendChild(container);
    }
  };

  function contractRow(c){
    var w=document.createElement("div"); w.className="list-item";
    var L=document.createElement("div");
    var top=document.createElement("div"); top.style.display="flex"; top.style.gap="10px"; top.style.alignItems="center";
    if (c.imageUrl) { var im=document.createElement("img"); im.src=c.imageUrl; im.className="thumb"; top.appendChild(im); }
    var title=document.createElement("div"); 
    title.appendChild(document.createTextNode(c.question));
    top.appendChild(title);
    var meta=document.createElement("div"); meta.className="meta";
    var resolution = c.resolution ? " Â· RESOLVED: " + c.resolution.toUpperCase() : "";
    meta.textContent=c.category+" Â· YES "+Math.round((c.yesPrice||0.5)*100)+"Â¢ Â· NO "+Math.round((c.noPrice||0.5)*100)+"Â¢ Â· Volume "+c.volume+resolution;
    L.appendChild(top); L.appendChild(meta);

    var R=document.createElement("div"); R.className="flex";
    var code=document.createElement("code"); code.textContent=c.id; code.style.fontSize="11px";
    var liveBtn=document.createElement("button");
    // Explicitly check for live field - handle undefined, null, false, and true
    var isLive = c.live === true || c.live === "true" || c.live === 1;
    console.log("ðŸ”µ Rendering contract button:", { id: c.id, live: c.live, isLive: isLive });
    liveBtn.textContent=isLive?"ðŸ”´ Un-Live":"âšª Mark Live";
    liveBtn.style.marginRight="4px";
    liveBtn.style.background=isLive?"#dc2626":"#6b7280";
    liveBtn.style.color="#fff";
    liveBtn.disabled=!!c.resolution;
    liveBtn.onclick=function(){
      var newLiveValue = !isLive;
      console.log("ðŸ”µ Regular contract button clicked:", { contractId: c.id, currentLive: isLive, newLiveValue: newLiveValue, typeof: typeof newLiveValue });
      toggleLive(c.id, newLiveValue);
    };
    var trendingBtn=document.createElement("button"); 
    trendingBtn.textContent=c.trending?"Trending":"Make Trending";
    trendingBtn.style.marginRight="4px";
    trendingBtn.style.backgroundColor=c.trending?"#f59e0b":"#6b7280";
    trendingBtn.style.color="white";
    trendingBtn.onclick=function(){toggleTrending(c.id, !c.trending)};
    var editBtn=document.createElement("button"); editBtn.textContent="Edit"; editBtn.style.marginRight="4px";
    editBtn.disabled=!!c.resolution;
    editBtn.onclick=function(){editContract(c)};
    var resolveBtn=document.createElement("button"); resolveBtn.textContent=c.resolution?"Resolved":"Resolve";
    resolveBtn.disabled=!!c.resolution;
    resolveBtn.onclick=function(){resolveContract(c.id)};
    var del=document.createElement("button"); del.className="danger"; del.textContent="Delete";
    del.onclick=function(){removeContract(c.id)};
    R.appendChild(code); R.appendChild(liveBtn); R.appendChild(trendingBtn); R.appendChild(editBtn); R.appendChild(resolveBtn); R.appendChild(del);

    w.appendChild(L); w.appendChild(R); return w;
  }

  async function loadContracts(){
    var token = getT();
    if (!token) {
      contractList.innerHTML="<div class='meta' style='color:#ef4444'>Please set admin token first</div>";
      return;
    }
    var r=await fetch(apiEndpoint("/api/contracts"),{headers:{"x-admin-token":token}});
    if(!r.ok){
      if(r.status===401){
        contractList.innerHTML="<div class='meta' style='color:#ef4444'>Unauthorized. Check your admin token (default: 'changeme')</div>";
      }else{
        contractList.innerHTML="<div class='meta'>Failed to load contracts: "+r.status+"</div>";
      }
      return;
    }
    var j=await r.json(); if(!j.ok){contractList.innerHTML="<div class='meta'>Failed: "+(j.error||"unknown")+"</div>";return}
    contractList.innerHTML="";
    if(!j.data||!j.data.length){ var e=document.createElement("div");e.className="meta";e.textContent="No contracts yet.";contractList.appendChild(e);return;}
    for(var i=0;i<j.data.length;i++) contractList.appendChild(contractRow(j.data[i]));
  }

  async function uploadContractImage(){
    if (!contractImg.files || !contractImg.files[0]) return null;
    var fd = new FormData();
    fd.append("image", contractImg.files[0]);
    var r = await fetch(apiEndpoint("/api/upload"),{ method:"POST", headers:{ "x-admin-token":getT() }, body: fd });
    if (!r.ok) { throw new Error("Upload failed: "+r.status); }
    var j = await r.json();
    if (!j.ok) { throw new Error("Upload failed: "+(j.error||"unknown")); }
    return j.url;
  }

  async function createContract(){
    try{
      // Prevent double-submission
      var btn = createContractBtn;
      if (btn.disabled) {
        console.log("Contract creation already in progress, ignoring duplicate click");
        return;
      }
      
      var token = getT();
      if (!token) {
        alert("Please set admin token first (default: 'changeme')");
        return;
      }
      token = String(token).trim();
      if(!contractQ.value.trim()){alert("Question required");return}
      
      // Disable button and show loading state
      var originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = "Creating...";
      
      try {
        var imageUrl = await uploadContractImage();
        var expirationDate = contractExp.value ? new Date(contractExp.value).toISOString() : null;
        var payload = { 
          question: contractQ.value.trim(), 
          description: contractDesc.value.trim(), 
          category: contractCat.value, 
          expirationDate: expirationDate,
          imageUrl: imageUrl,
          subjectId: contractSubjectId.value || null
        };
        var r=await fetch(apiEndpoint("/api/contracts/create"),{ 
          method:"POST", 
          headers: { "Content-Type":"application/json","x-admin-token":token }, 
          body: JSON.stringify(payload) 
        });
        if(!r.ok){
          var errorText = await r.text().catch(() => "");
          var errorJson = {};
          try { errorJson = JSON.parse(errorText); } catch {}
          
          if(r.status===401){
            alert("Unauthorized. Check your admin token. Make sure it matches the ADMIN_TOKEN on your server.\n\nCurrent API URL: " + getApiUrl());
          }else if(r.status===409 || errorJson.duplicate){
            // Duplicate contract detected
            var duplicateMsg = "âš ï¸ DUPLICATE CONTRACT DETECTED\n\n" + (errorJson.error || "A contract with this question already exists.");
            if(errorJson.existingContractId){
              duplicateMsg += "\n\nExisting Contract ID: " + errorJson.existingContractId;
            }
            duplicateMsg += "\n\nNo new contract was created. Please use a different question or edit the existing contract.";
            alert(duplicateMsg);
          }else if(r.status===0 || r.status===404){
            alert("Connection failed. The server at " + getApiUrl() + " is not reachable.\n\nMake sure:\n1. The API URL is correct\n2. The server is running\n3. CORS is configured properly");
          }else{
            alert("Create failed (Status " + r.status + "): " + (errorJson.error || errorText || "Unknown error") + "\n\nAPI URL: " + getApiUrl());
          }
          return;
        }
        var j=await r.json(); 
        if(!j.ok){
          alert("Create failed: " + (j.error || "unknown") + "\n\nAPI URL: " + getApiUrl());
          return;
        }
        contractQ.value=""; contractDesc.value=""; contractExp.value=""; contractSubjectId.value=""; contractImg.value=""; contractPreview.innerHTML="";
        loadContracts();
        alert("Contract created successfully!\n\nCreated on: " + getApiUrl() + "\nContract ID: " + (j.data?.id || "N/A") + "\n\nRefresh your website to see it.");
      } finally {
        // Re-enable button
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }catch(e){ 
      // Re-enable button on error
      if (createContractBtn) {
        createContractBtn.disabled = false;
        createContractBtn.textContent = "Create Contract";
      }
      alert(e.message || "Could not create contract"); 
    }
  }

  async function removeContract(id){
    if (!confirm("Delete contract "+id+"? This cannot be undone.")) return;
    var token = getT();
    var r=await fetch(apiEndpoint("/api/contracts/"+encodeURIComponent(id)),{ 
      method:"DELETE", 
      headers:{ "x-admin-token":token }
    });
    if(!r.ok){
      var j=await r.json().catch(()=>({}));
      alert("Delete failed: "+(j.error||r.status));
      return;
    }
    loadContracts();
    alert("Contract deleted!");
  }

  async function cleanupDuplicates(){
    if (!confirm("This will remove all duplicate contracts with the same question (keeping the oldest one). Continue?")) return;
    var token = getT();
    if (!token) {
      alert("Please set admin token first (default: 'changeme')");
      return;
    }
    var btn = document.getElementById("cleanupDuplicates");
    if (btn) {
      btn.disabled = true;
      btn.textContent = "Cleaning up...";
    }
    try {
      var r = await fetch(apiEndpoint("/api/contracts/cleanup-duplicates"), {
        method: "POST",
        headers: { "x-admin-token": token }
      });
      if (!r.ok) {
        var j = await r.json().catch(() => ({}));
        alert("Cleanup failed: " + (j.error || r.status));
        return;
      }
      var j = await r.json();
      if (!j.ok) {
        alert("Cleanup failed: " + (j.error || "unknown"));
        return;
      }
      loadContracts();
      alert("Cleanup complete!\n\nRemoved: " + (j.removed || 0) + " duplicate(s)\nKept: " + (j.kept || 0) + " unique contract(s)");
    } catch (e) {
      alert("Error: " + (e.message || "Could not cleanup duplicates"));
    } finally {
      if (btn) {
        btn.disabled = false;
        btn.textContent = "Remove Duplicate Contracts";
      }
    }
  }

  function editContract(c){
    contractQ.value=c.question||"";
    contractDesc.value=c.description||"";
    contractCat.value=c.category||"General";
    contractExp.value=c.expirationDate ? new Date(c.expirationDate).toISOString().split('T')[0] : "";
    contractImg.value="";
    contractPreview.innerHTML="";
    if(c.imageUrl){
      var img=document.createElement("img");
      img.src=c.imageUrl;
      img.className="thumb";
      contractPreview.appendChild(img);
    }
    
    var btn=createContractBtn;
    var originalText=btn.textContent;
    btn.textContent="Update Contract";
    btn.onclick=function(){
      updateContract(c.id);
      btn.textContent=originalText;
      btn.onclick=function(){createContract();};
    };
    
    document.querySelector("#contractQ").scrollIntoView({behavior:"smooth",block:"center"});
  }

  async function updateContract(id){
    try{
      var token = getT();
      if (!token) {
        alert("Please set admin token first (default: 'changeme')");
        return;
      }
      token = String(token).trim();
      if(!contractQ.value.trim()){alert("Question required");return}
      var imageUrl = await uploadContractImage();
      var expirationDate = contractExp.value ? new Date(contractExp.value).toISOString() : null;
      var payload = { 
        question: contractQ.value.trim(), 
        description: contractDesc.value.trim(), 
        category: contractCat.value, 
        expirationDate: expirationDate
      };
      if(imageUrl) payload.imageUrl = imageUrl;
      
      var r=await fetch(apiEndpoint("/api/contracts/"+encodeURIComponent(id)),{ 
        method:"PATCH", 
        headers: { "Content-Type":"application/json","x-admin-token":token }, 
        body: JSON.stringify(payload) 
      });
      if(!r.ok){
        var j=await r.json().catch(()=>({}));
        if(r.status===401){
          alert("Unauthorized. Check your admin token (default: 'changeme')");
        }else{
          alert("Update failed: "+(j.error||r.status));
        }
        return;
      }
      var j=await r.json(); if(!j.ok){alert("Update failed: "+(j.error||"unknown"));return}
      contractQ.value=""; contractDesc.value=""; contractExp.value=""; contractImg.value=""; contractPreview.innerHTML="";
      loadContracts();
      alert("Contract updated!");
    }catch(e){ alert(e.message || "Could not update contract"); }
  }

  async function toggleTrending(id, trending){
    try{
      var token = getT();
      if (!token) {
        alert("Please set admin token first (default: 'changeme')");
        return;
      }
      token = String(token).trim();
      var r=await fetch(apiEndpoint("/api/contracts/"+encodeURIComponent(id)),{ 
        method:"PATCH", 
        headers: { "Content-Type":"application/json","x-admin-token":token }, 
        body: JSON.stringify({ trending: trending }) 
      });
      if(!r.ok){
        var j=await r.json().catch(()=>({}));
        if(r.status===401){
          alert("Unauthorized. Check your admin token (default: 'changeme')");
        }else{
          var errorMsg = j.error || r.status || "Unknown error";
          var debugInfo = j.debug ? "\n\nDebug info: " + JSON.stringify(j.debug, null, 2) : "";
          
          // Log full error to console for debugging
          console.error("Update failed - Full error response:", j);
          
          // If error contains SQL instructions, show them clearly
          if(errorMsg.includes("ALTER TABLE") || errorMsg.includes("column does not exist") || errorMsg.includes("Database schema error")){
            alert("DATABASE SCHEMA ERROR:\n\n" + errorMsg + debugInfo + "\n\nPlease run the SQL command shown above in your Supabase SQL Editor.");
          }else{
            alert("Update failed: " + errorMsg + debugInfo);
          }
        }
        return;
      }
      var j=await r.json(); if(!j.ok){
        var errorMsg = j.error || "unknown";
        if(errorMsg.includes("ALTER TABLE") || errorMsg.includes("column does not exist")){
          alert("DATABASE SCHEMA ERROR:\n\n" + errorMsg + "\n\nPlease run the SQL command shown above in your Supabase SQL Editor.");
        }else{
          alert("Update failed: " + errorMsg);
        }
        return;
      }
      loadContracts();
    }catch(e){ alert(e.message || "Could not update contract"); }
  }

  async function resolveContract(id){
    var resolution = prompt("Resolve as YES or NO?", "yes");
    if (!resolution || (resolution.toLowerCase() !== "yes" && resolution.toLowerCase() !== "no")) return;
      var r=await fetch(apiEndpoint("/api/contracts/"+encodeURIComponent(id)+"/resolve"),{ 
      method:"POST", 
      headers:{ "Content-Type":"application/json","x-admin-token":getT() }, 
      body: JSON.stringify({resolution: resolution.toLowerCase()})
    });
    if(!r.ok){alert("Resolve failed: "+r.status);return}
    var j=await r.json(); if(!j.ok){alert("Resolve failed: "+(j.error||"unknown"));return}
    loadContracts();
    alert("Contract resolved! Winners have been paid.");
  }

  async function toggleLive(id, live){
    try{
      var token = getT();
      if (!token) {
        alert("Please set admin token first (default: 'changeme')");
        return;
      }
      token = String(token).trim();
      // Convert to explicit boolean - handle both true and false explicitly
      var liveValue;
      // First check for explicit false values
      if (live === false || live === "false" || live === 0 || live === null || live === undefined) {
        liveValue = false;
        console.log("ðŸ”µ Detected FALSE value, setting liveValue to false");
      } else if (live === true || live === "true" || live === 1) {
        liveValue = true;
        console.log("ðŸ”µ Detected TRUE value, setting liveValue to true");
      } else {
        // Default to false for any other value
        liveValue = false;
        console.log("ðŸ”µ Unknown value, defaulting to false");
      }
      console.log("ðŸ”µ Toggling live status:", { 
        id: id, 
        receivedValue: live, 
        typeof: typeof live,
        convertedValue: liveValue,
        willSend: JSON.stringify({live: liveValue})
      });
      var r=await fetch(apiEndpoint("/api/contracts/"+encodeURIComponent(id)),{ 
        method:"PATCH", 
        headers: { "Content-Type":"application/json","x-admin-token":token }, 
        body: JSON.stringify({live: liveValue}) 
      });
      if(!r.ok){
        var errorText = await r.text().catch(() => "");
        var j = await JSON.parse(errorText).catch(()=>({}));
        console.error("âŒ Update failed:", { status: r.status, error: j.error || errorText });
        if(r.status===401){
          alert("Unauthorized. Check your admin token (default: 'changeme')");
        }else{
          alert("Update failed: "+(j.error||r.status||"Unknown error"));
        }
        return;
      }
      var j=await r.json(); 
      if(!j.ok){
        console.error("âŒ Response not ok:", j);
        alert("Update failed: "+(j.error||"unknown"));
        return;
      }
      console.log("âœ… Update successful:", j.data);
      console.log("ðŸ”µ Reloading contracts...");
      // Reload both lists
      await Promise.all([loadContracts()]);
      // Small delay to ensure UI updates
      await new Promise(resolve => setTimeout(resolve, 100));
      var message = liveValue ? "âœ… Contract marked as LIVE! It will now appear on the /live page." : "âœ… Contract un-marked as live. It will no longer appear on the /live page.";
      console.log("ðŸ”µ Showing alert:", message);
      alert(message);
    }catch(e){ 
      console.error("âŒ Error in toggleLive:", e);
      alert(e.message || "Could not update contract"); 
    }
  }


  // Features elements
  var featureTitle=document.getElementById("featureTitle");
  var featureDesc=document.getElementById("featureDesc");
  var featureType=document.getElementById("featureType");
  var featureStatus=document.getElementById("featureStatus");
  var featureImg=document.getElementById("featureImg");
  var featurePreview=document.getElementById("featurePreview");
  var featureUrl=document.getElementById("featureUrl");
  var featureSubjectId=document.getElementById("featureSubjectId");
  var createFeatureBtn=document.getElementById("createFeature");
  var featureList=document.getElementById("featureList");

  if(createFeatureBtn){
    createFeatureBtn.onclick=function(){createFeature();};
  }

  async function createFeature(){
    try{
      var token = getT();
      if (!token) {
        alert("Please set admin token first (default: 'changeme')");
        return;
      }
      token = String(token).trim();
      if(!featureTitle.value.trim()){alert("Title required");return}
      if(!featureDesc.value.trim()){alert("Description required");return}
      
      var imageUrl = await uploadFeatureImage();
      var payload = { 
        title: featureTitle.value.trim(), 
        description: featureDesc.value.trim(), 
        type: featureType.value,
        status: featureStatus.value,
        url: featureUrl.value.trim() || null,
        imageUrl: imageUrl || null,
        subjectId: featureSubjectId.value || null
      };
      
      var r=await fetch(apiEndpoint("/api/features/create"),{ 
        method:"POST", 
        headers: { "Content-Type":"application/json","x-admin-token":token }, 
        body: JSON.stringify(payload) 
      });
      if(!r.ok){
        var j = await r.json().catch(()=>({}));
        if(r.status===401){
          alert("Unauthorized. Check your admin token (default: 'changeme')");
        }else{
          alert("Create failed: "+(j.error||r.status));
        }
        return;
      }
      var j=await r.json(); if(!j.ok){alert("Create failed: "+(j.error||"unknown"));return}
      featureTitle.value=""; featureDesc.value=""; featureType.value="Campaign"; featureStatus.value="Draft"; featureUrl.value=""; featureSubjectId.value=""; featureImg.value=""; featurePreview.innerHTML="";
      loadFeatures();
      alert("Feature created!");
    }catch(e){ alert(e.message || "Could not create feature"); }
  }

  async function uploadFeatureImage(){
    if(!featureImg.files || !featureImg.files[0]) return null;
    try{
      var formData=new FormData();
      formData.append("image",featureImg.files[0]);
      var uploadUrl = apiEndpoint("/api/upload");
      var r=await fetch(uploadUrl,{method:"POST",headers:{"x-admin-token":getT()},body:formData});
      if(!r.ok) throw new Error("Upload failed");
      var j=await r.json();
      return j.url||null;
    }catch(e){
      console.error("Image upload error:",e);
      return null;
    }
  }

  if(featureImg){
    featureImg.onchange=function(){
      featurePreview.innerHTML="";
      if(featureImg.files && featureImg.files[0]){
        var url = URL.createObjectURL(featureImg.files[0]);
        var el = document.createElement("img");
        el.src = url; el.className = "thumb";
        featurePreview.appendChild(el);
      }
    };
  }

  async function loadFeatures(){
    try{
      var token = getT();
      if (!token) {
        featureList.innerHTML = "<div class='meta'>Please set admin token first</div>";
        return;
      }
      token = String(token).trim();
      
      // Load subjects for dropdown
      if (featureSubjectId) {
        var subjectsR = await fetch(apiEndpoint("/api/subjects"), { headers: { "x-admin-token": token } });
        if (subjectsR.ok) {
          var subjectsJ = await subjectsR.json();
          if (subjectsJ.ok && subjectsJ.data && subjectsJ.data.length) {
            featureSubjectId.innerHTML = "<option value=''>None</option>";
            for (var i = 0; i < subjectsJ.data.length; i++) {
              var opt = document.createElement("option");
              opt.value = subjectsJ.data[i].id;
              opt.textContent = subjectsJ.data[i].name;
              featureSubjectId.appendChild(opt);
            }
          }
        }
      }
      
      var r=await fetch(apiEndpoint("/api/features"),{ 
        headers: { "x-admin-token":token } 
      });
      if(!r.ok){
        featureList.innerHTML = "<div class='meta'>Failed to load features</div>";
        return;
      }
      var j=await r.json();
      if(!j.ok || !Array.isArray(j.data)){
        featureList.innerHTML = "<div class='meta'>No features found</div>";
        return;
      }
      if(j.data.length===0){
        featureList.innerHTML = "<div class='meta'>No features created yet</div>";
        return;
      }
      featureList.innerHTML="";
      j.data.forEach(function(f){
        featureList.appendChild(featureRow(f));
      });
    }catch(e){
      featureList.innerHTML = "<div class='meta'>Error loading features: "+(e.message||"unknown")+"</div>";
    }
  }

  function featureRow(f){
    var w=document.createElement("div"); w.className="list-item";
    var L=document.createElement("div");
    var top=document.createElement("div"); top.style.display="flex"; top.style.gap="10px"; top.style.alignItems="center";
    if (f.imageUrl) { var im=document.createElement("img"); im.src=f.imageUrl; im.className="thumb"; top.appendChild(im); }
    var title=document.createElement("div"); 
    title.appendChild(document.createTextNode(f.title||"Untitled"));
    top.appendChild(title);
    var meta=document.createElement("div"); meta.className="meta";
    var statusText = f.status||"Draft";
    var statusColor = statusText === "Active" ? "#10b981" : (statusText === "Draft" ? "#9ca3af" : "#f59e0b");
    meta.innerHTML = (f.type||"Campaign")+" Â· <span style='color:"+statusColor+";font-weight:500'>"+statusText+"</span>"+(f.url ? " Â· "+f.url : "");
    if(statusText === "Active"){
      meta.innerHTML += " <span style='color:#10b981;font-size:11px'>âœ“ Visible on website</span>";
    }else{
      meta.innerHTML += " <span style='color:#ef4444;font-size:11px'>âš  Not visible (set to Active to show)</span>";
    }
    L.appendChild(top); L.appendChild(meta);

    var R=document.createElement("div"); R.className="flex"; R.style.gap="8px";
    
    // Status dropdown
    var statusSelect=document.createElement("select");
    statusSelect.style.padding="4px 8px";
    statusSelect.style.borderRadius="4px";
    statusSelect.value=f.status||"Draft";
    var statuses=["Draft","Active","Paused","Completed"];
    statuses.forEach(function(s){
      var opt=document.createElement("option");
      opt.value=s;
      opt.textContent=s;
      statusSelect.appendChild(opt);
    });
    statusSelect.onchange=function(){
      updateFeatureStatus(f.id,statusSelect.value);
    };
    R.appendChild(statusSelect);
    
    var del=document.createElement("button"); del.className="danger"; del.textContent="Delete";
    del.onclick=function(){removeFeature(f.id)};
    R.appendChild(del);

    w.appendChild(L); w.appendChild(R); return w;
  }

  async function updateFeatureStatus(id, newStatus){
    try{
      var token = getT();
      if (!token) {
        alert("Please set admin token first (default: 'changeme')");
        return;
      }
      token = String(token).trim();
      console.log("ðŸ”µ Updating feature status:", { id: id, newStatus: newStatus });
      var r=await fetch(apiEndpoint("/api/features/"+encodeURIComponent(id)),{ 
        method:"PATCH", 
        headers: { "Content-Type":"application/json","x-admin-token":token },
        body: JSON.stringify({ status: newStatus })
      });
      if(!r.ok){
        var j = await r.json().catch(()=>({}));
        console.error("âŒ Update failed:", { status: r.status, error: j.error });
        if(r.status===401){
          alert("Unauthorized. Check your admin token (default: 'changeme')");
        }else{
          alert("Update failed: "+(j.error||r.status));
        }
        return;
      }
      var j=await r.json(); 
      if(!j.ok){
        console.error("âŒ Response not ok:", j);
        alert("Update failed: "+(j.error||"unknown"));
        return;
      }
      console.log("âœ… Update successful:", j.data);
      loadFeatures();
      if(newStatus==="Active"){
        alert("âœ… Feature is now Active! It will appear on the website. Refresh the homepage to see it.");
      }else{
        alert("âœ… Feature status updated to: "+newStatus);
      }
    }catch(e){ 
      console.error("âŒ Error updating feature:", e);
      alert(e.message || "Could not update feature"); 
    }
  }

  async function removeFeature(id){
    if(!confirm("Delete this feature?")) return;
    try{
      var token = getT();
      if (!token) {
        alert("Please set admin token first (default: 'changeme')");
        return;
      }
      token = String(token).trim();
      var r=await fetch(apiEndpoint("/api/features/"+encodeURIComponent(id)),{ 
        method:"DELETE", 
        headers: { "x-admin-token":token } 
      });
      if(!r.ok){
        var j = await r.json().catch(()=>({}));
        if(r.status===401){
          alert("Unauthorized. Check your admin token (default: 'changeme')");
        }else{
          alert("Delete failed: "+(j.error||r.status));
        }
        return;
      }
      var j=await r.json(); if(!j.ok){alert("Delete failed: "+(j.error||"unknown"));return}
      loadFeatures();
      alert("Feature deleted!");
    }catch(e){ alert(e.message || "Could not delete feature"); }
  }

  // Accounts elements
  var accountsList=document.getElementById("accountsList");

  function accountRow(user){
    var w=document.createElement("div"); w.className="list-item";
    var L=document.createElement("div");
    var top=document.createElement("div"); top.style.fontWeight="500"; top.style.marginBottom="4px";
    top.textContent=user.email;
    var meta=document.createElement("div"); meta.className="meta";
    var createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : "Unknown";
    meta.textContent="Username: "+(user.username||"Not set")+" Â· Created: "+createdDate;
    var balance=document.createElement("div"); balance.style.marginTop="8px"; balance.style.color="#10b981";
    balance.textContent="Cash: $"+user.cash.toFixed(2)+" Â· Portfolio: $"+user.portfolio.toFixed(2)+" Â· Total: $"+user.totalBalance.toFixed(2);
    L.appendChild(top); L.appendChild(meta); L.appendChild(balance);

    var R=document.createElement("div"); R.className="flex";
    var code=document.createElement("code"); code.textContent=user.email; code.style.fontSize="11px"; code.style.color="#9ca3af";
    R.appendChild(code);

    w.appendChild(L); w.appendChild(R); return w;
  }

  async function loadAccounts(){
    var token = getT();
    if (!token) {
      accountsList.innerHTML="<div class='meta' style='color:#ef4444'>Please set admin token first</div>";
      return;
    }
    var r=await fetch(apiEndpoint("/api/users"),{headers:{"x-admin-token":token}});
    if(!r.ok){
      if(r.status===401){
        accountsList.innerHTML="<div class='meta' style='color:#ef4444'>Unauthorized. Check your admin token (default: 'changeme')</div>";
      }else{
        accountsList.innerHTML="<div class='meta'>Failed to load accounts: "+r.status+"</div>";
      }
      return;
    }
    var j=await r.json(); 
    if(!j.ok){
      accountsList.innerHTML="<div class='meta'>Failed: "+(j.error||"unknown")+"</div>";
      return;
    }
    accountsList.innerHTML="";
    if(!j.data||!j.data.length){ 
      var e=document.createElement("div");
      e.className="meta";
      e.textContent="No user accounts yet.";
      accountsList.appendChild(e);
      return;
    }
    for(var i=0;i<j.data.length;i++) accountsList.appendChild(accountRow(j.data[i]));
  }

  // Event listeners
  if(createContractBtn) createContractBtn.onclick=function(){ createContract(); };
  if(createNewsBtn) createNewsBtn.onclick=function(){ createNews(); };
  if(createBlogBtn) createBlogBtn.onclick=function(){ createBlog(); };
  
  // Cleanup duplicates button
  var cleanupDuplicatesBtn = document.getElementById("cleanupDuplicates");
  if(cleanupDuplicatesBtn) cleanupDuplicatesBtn.onclick=function(){ cleanupDuplicates(); };

  // Sports elements removed - sports section deleted

  // Subjects elements

  // Subjects elements
  var subjectName = document.getElementById("subjectName"),
      subjectDesc = document.getElementById("subjectDesc"),
      createSubjectBtn = document.getElementById("createSubject"),
      subjectsList = document.getElementById("subjectsList");

  function subjectRow(s){
    var w = document.createElement("div"); w.className = "list-item";
    var L = document.createElement("div");
    var top = document.createElement("div"); top.style.fontWeight = "500"; top.style.marginBottom = "4px";
    top.textContent = s.name;
    var meta = document.createElement("div"); meta.className = "meta";
    meta.textContent = (s.description || "No description") + " Â· Slug: " + (s.slug || "");
    L.appendChild(top); L.appendChild(meta);

    var R = document.createElement("div"); R.className = "flex";
    var code = document.createElement("code"); code.textContent = s.id; code.style.fontSize = "11px";
    var del = document.createElement("button"); del.className = "danger"; del.textContent = "Delete";
    del.onclick = function(){ removeSubject(s.id); };
    R.appendChild(code); R.appendChild(del);

    w.appendChild(L); w.appendChild(R); return w;
  }

  async function loadSubjects(){
    var token = getT();
    if (!subjectsList) {
      console.error("subjectsList element not found");
      return;
    }
    if (!token) {
      subjectsList.innerHTML = "<div class='meta' style='color:#ef4444'>Please set admin token first</div>";
      return;
    }
    var r = await fetch(apiEndpoint("/api/subjects"), { headers: { "x-admin-token": token } });
    if (!r.ok) {
      if (r.status === 401) {
        subjectsList.innerHTML = "<div class='meta' style='color:#ef4444'>Unauthorized. Check your admin token (default: 'changeme')</div>";
      } else {
        subjectsList.innerHTML = "<div class='meta'>Failed to load subjects: " + r.status + "</div>";
      }
      return;
    }
    var j = await r.json();
    if (!j.ok) {
      subjectsList.innerHTML = "<div class='meta'>Failed: " + (j.error || "unknown") + "</div>";
      return;
    }
    subjectsList.innerHTML = "";
    if (!j.data || !j.data.length) {
      var e = document.createElement("div");
      e.className = "meta";
      e.textContent = "No subjects yet. Create one above.";
      subjectsList.appendChild(e);
      return;
    }
    for (var i = 0; i < j.data.length; i++) {
      subjectsList.appendChild(subjectRow(j.data[i]));
    }
  }

  async function createSubject(){
    try {
      var token = getT();
      if (!token) {
        alert("Please set admin token first (default: 'changeme')");
        return;
      }
      token = String(token).trim();
      if (!subjectName.value.trim()) {
        alert("Subject name required");
        return;
      }
      
      var payload = {
        name: subjectName.value.trim(),
        description: subjectDesc.value.trim() || null
      };
      
      var r = await fetch(apiEndpoint("/api/subjects"), {
        method: "POST",
        headers: { "Content-Type": "application/json", "x-admin-token": token },
        body: JSON.stringify(payload)
      });
      if (!r.ok) {
        if (r.status === 401) {
          alert("Unauthorized. Check your admin token (default: 'changeme')");
        } else {
          var errorText = await r.text().catch(() => "");
          var j;
          try { j = JSON.parse(errorText); } catch { j = {}; }
          alert("Create failed: " + (j.error || r.status || "Unknown error"));
        }
        return;
      }
      var j = await r.json();
      if (!j.ok) {
        alert("Create failed: " + (j.error || "unknown"));
        return;
      }
      subjectName.value = "";
      subjectDesc.value = "";
      loadSubjects();
      alert("Subject created successfully!");
    } catch (e) {
      alert(e.message || "Could not create subject");
    }
  }

  async function removeSubject(id){
    if (!confirm("Delete this subject? This cannot be undone.")) return;
    var token = getT();
    var r = await fetch(apiEndpoint("/api/subjects/" + encodeURIComponent(id)), {
      method: "DELETE",
      headers: { "x-admin-token": token }
    });
    if (!r.ok) {
      var j = await r.json().catch(() => ({}));
      alert("Delete failed: " + (j.error || r.status));
      return;
    }
    loadSubjects();
    alert("Subject deleted!");
  }

  if(createSubjectBtn) createSubjectBtn.onclick = function(){ createSubject(); };

  // Footer Content elements
  var footerContentType = document.getElementById("footerContentType"),
      footerContentTitle = document.getElementById("footerContentTitle"),
      footerContentBody = document.getElementById("footerContentBody"),
      footerContentAuthor = document.getElementById("footerContentAuthor"),
      footerContentDate = document.getElementById("footerContentDate"),
      footerContentImg = document.getElementById("footerContentImg"),
      footerContentPreview = document.getElementById("footerContentPreview"),
      createFooterContentBtn = document.getElementById("createFooterContent"),
      footerContentList = document.getElementById("footerContentList");

  // Image preview for footer content
  if(footerContentImg) {
    footerContentImg.onchange = function(e) {
      var file = e.target.files[0];
      if (file) {
        var reader = new FileReader();
        reader.onload = function(event) {
          footerContentPreview.innerHTML = "<img src='" + event.target.result + "' style='max-width:200px;max-height:150px;border-radius:8px;border:1px solid #374151' />";
        };
        reader.readAsDataURL(file);
      } else {
        footerContentPreview.innerHTML = "";
      }
    };
  }

  function footerContentRow(fc) {
    var w = document.createElement("div"); w.className = "list-item";
    var L = document.createElement("div");
    var top = document.createElement("div"); top.style.fontWeight = "500"; top.style.marginBottom = "4px";
    top.textContent = fc.title || "Untitled";
    var meta = document.createElement("div"); meta.className = "meta";
    meta.textContent = (fc.contentType || "Unknown") + " Â· " + (fc.author || "No author") + " Â· " + (fc.publishedDate || "No date");
    L.appendChild(top); L.appendChild(meta);

    var R = document.createElement("div"); R.className = "flex";
    var editBtn = document.createElement("button"); editBtn.textContent = "Edit"; editBtn.style.marginRight = "4px";
    editBtn.onclick = function(){ editFooterContent(fc); };
    var del = document.createElement("button"); del.className = "danger"; del.textContent = "Delete";
    del.onclick = function(){ removeFooterContent(fc.id); };
    R.appendChild(editBtn); R.appendChild(del);

    w.appendChild(L); w.appendChild(R); return w;
  }

  async function loadFooterContent() {
    var token = getT();
    if (!footerContentList) {
      console.error("footerContentList element not found");
      return;
    }
    if (!token) {
      footerContentList.innerHTML = "<div class='meta' style='color:#ef4444'>Please set admin token first</div>";
      return;
    }
    try {
      var r = await fetch(apiEndpoint("/api/footer-content"), { headers: { "x-admin-token": token } });
      if (!r.ok) {
        if (r.status === 401) {
          footerContentList.innerHTML = "<div class='meta' style='color:#ef4444'>Unauthorized. Check your admin token (default: 'changeme')</div>";
        } else if (r.status === 404) {
          // API endpoint doesn't exist yet, show empty state
          footerContentList.innerHTML = "<div class='meta'>No footer content yet. Create one above.</div>";
        } else {
          footerContentList.innerHTML = "<div class='meta'>Failed to load footer content: " + r.status + "</div>";
        }
        return;
      }
      var j = await r.json();
      if (!j.ok) {
        footerContentList.innerHTML = "<div class='meta'>Failed: " + (j.error || "unknown") + "</div>";
        return;
      }
      footerContentList.innerHTML = "";
      if (!j.data || !j.data.length) {
        var e = document.createElement("div");
        e.className = "meta";
        e.textContent = "No footer content yet. Create one above.";
        footerContentList.appendChild(e);
        return;
      }
      for (var i = 0; i < j.data.length; i++) {
        footerContentList.appendChild(footerContentRow(j.data[i]));
      }
    } catch (e) {
      footerContentList.innerHTML = "<div class='meta' style='color:#ef4444'>Error loading footer content: " + e.message + "</div>";
    }
  }

  async function createFooterContent() {
    try {
      var token = getT();
      if (!token) {
        alert("Please set admin token first (default: 'changeme')");
        return;
      }
      token = String(token).trim();
      if (!footerContentType.value || !footerContentTitle.value.trim() || !footerContentBody.value.trim()) {
        alert("Content type, title, and body are required");
        return;
      }
      
      var payload = {
        contentType: footerContentType.value,
        title: footerContentTitle.value.trim(),
        body: footerContentBody.value.trim(),
        author: footerContentAuthor.value.trim() || null,
        publishedDate: footerContentDate.value || null
      };

      // Handle image upload if provided
      var imageUrl = null;
      if (footerContentImg && footerContentImg.files && footerContentImg.files[0]) {
        var formData = new FormData();
        formData.append("file", footerContentImg.files[0]);
        try {
          var uploadR = await fetch("http://localhost:8788/upload", {
            method: "POST",
            body: formData
          });
          if (uploadR.ok) {
            var uploadJ = await uploadR.json();
            imageUrl = uploadJ.url || uploadJ.data?.url || null;
          }
        } catch (uploadErr) {
          console.warn("Image upload failed:", uploadErr);
        }
      }
      if (imageUrl) payload.imageUrl = imageUrl;
      
      var r = await fetch(apiEndpoint("/api/footer-content"), {
        method: "POST",
        headers: { "Content-Type": "application/json", "x-admin-token": token },
        body: JSON.stringify(payload)
      });
      if (!r.ok) {
        if (r.status === 401) {
          alert("Unauthorized. Check your admin token (default: 'changeme')");
        } else {
          var errorText = await r.text().catch(() => "");
          var j;
          try { j = JSON.parse(errorText); } catch { j = {}; }
          alert("Create failed: " + (j.error || r.status || "Unknown error"));
        }
        return;
      }
      var j = await r.json();
      if (!j.ok) {
        alert("Create failed: " + (j.error || "unknown"));
        return;
      }
      footerContentType.value = "blog";
      footerContentTitle.value = "";
      footerContentBody.value = "";
      footerContentAuthor.value = "";
      footerContentDate.value = "";
      footerContentImg.value = "";
      footerContentPreview.innerHTML = "";
      loadFooterContent();
      alert("Footer content created successfully!");
    } catch (e) {
      alert(e.message || "Could not create footer content");
    }
  }

  async function editFooterContent(fc) {
    if (!fc) return;
    footerContentType.value = fc.contentType || "blog";
    footerContentTitle.value = fc.title || "";
    footerContentBody.value = fc.body || "";
    footerContentAuthor.value = fc.author || "";
    footerContentDate.value = fc.publishedDate || "";
    if (fc.imageUrl) {
      footerContentPreview.innerHTML = "<img src='" + fc.imageUrl + "' style='max-width:200px;max-height:150px;border-radius:8px;border:1px solid #374151' />";
    }
    // Scroll to form
    document.getElementById("footerContentType").scrollIntoView({ behavior: "smooth", block: "start" });
    alert("Edit functionality: Update the form above and click 'Create Footer Content' to update (or implement a separate update endpoint)");
  }

  async function removeFooterContent(id) {
    if (!confirm("Delete this footer content? This cannot be undone.")) return;
    var token = getT();
    try {
      var r = await fetch(apiEndpoint("/api/footer-content/" + encodeURIComponent(id)), {
        method: "DELETE",
        headers: { "x-admin-token": token }
      });
      if (!r.ok) {
        var j = await r.json().catch(() => ({}));
        alert("Delete failed: " + (j.error || r.status));
        return;
      }
      loadFooterContent();
      alert("Footer content deleted!");
    } catch (e) {
      alert("Delete failed: " + e.message);
    }
  }

  if(createFooterContentBtn) createFooterContentBtn.onclick = function(){ createFooterContent(); };

  // Initial load - load all data for the active tab
  loadStats();
  loadContracts();
  loadNews();
  // Also load features and other tabs data on initial load so they're ready when user switches tabs
  loadFeatures();
  loadSports();
  loadSubjects();
  loadAccounts();
  loadBlog();
  loadFooterContent();
})();
</script>


