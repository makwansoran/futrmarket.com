const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/eth_getTransactionCount-DhE6m_ss.js","assets/index-Cn3kq7oy.js","assets/index-trjEgyRZ.css","assets/in-app-wallet-calls-Bu1gU1-o.js","assets/send-transaction-D6lpxEtY.js","assets/to-serializable-transaction-CINlwqk-.js","assets/random-NeYOSU-c.js"])))=>i.map(i=>d[i]);
import{r as d,w as h,h as w,b,i as f,_ as k,p as B,x as K,y as P,t as M,z as W,A as Y,C as v,D as z,E as _,F as X}from"./index-Cn3kq7oy.js";import{a as Z}from"./types-DC0Zmj1B.js";import{r as ee}from"./random-NeYOSU-c.js";import{e as G}from"./eth_sendRawTransaction-DPdnXbFR.js";const te="/sdk/2022-08-12/embedded-wallet",A=t=>`thirdwebEwsWalletUserId-${t}`,ne="walletToken",T=t=>`${ne}-${t}`,$=t=>`passkey-credential-id-${t}`,ie="a",E=(t,e)=>`${ie}-${t}-${e}`,j=t=>`walletConnectSessions-${t}`,D=t=>`thirdweb_guest_session_id_${t}`,U=new Map;class x{constructor({storage:e,clientId:n,ecosystem:i}){Object.defineProperty(this,"key",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"storage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.storage=e,this.key=ae(n,i?.id),this.ecosystem=i}async getItem(e){return this.storage?this.storage.getItem(e):U.get(e)??null}async setItem(e,n){if(this.storage)return this.storage.setItem(e,n);U.set(e,n)}async removeItem(e){const n=await this.getItem(e);return this.storage&&n?(this.storage.removeItem(e),!0):!1}async getWalletConnectSessions(){return this.getItem(j(this.key))}async saveWalletConnectSessions(e){await this.setItem(j(this.key),e)}async savePasskeyCredentialId(e){await this.setItem($(this.key),e)}async getPasskeyCredentialId(){return this.getItem($(this.key))}async saveAuthCookie(e){await this.setItem(T(this.key),e)}async getAuthCookie(){return this.getItem(T(this.key))}async removeAuthCookie(){return this.removeItem(T(this.key))}async saveDeviceShare(e,n){await this.saveWalletUserId(n),await this.setItem(E(this.key,n),e)}async getDeviceShare(){const e=await this.getWalletUserId();return e?this.getItem(E(this.key,e)):null}async removeDeviceShare(){const e=await this.getWalletUserId();return e?this.removeItem(E(this.key,e)):!1}async getWalletUserId(){return this.getItem(A(this.key))}async saveWalletUserId(e){await this.setItem(A(this.key),e)}async removeWalletUserId(){return this.removeItem(A(this.key))}async getGuestSessionId(){return this.getItem(D(this.key))}async saveGuestSessionId(e){await this.setItem(D(this.key),e)}}const ae=(t,e)=>`${t}${e?`-${e}`:""}`,H=t=>{if(!Z.includes(t))throw new Error(`Unknown auth option ${t}`);switch(t){case"wallet":return"siwe";default:return t}},I=({authOption:t,client:e,ecosystem:n,mode:i="popup",redirectUrl:s})=>{if(i==="popup"&&s)throw new Error("Redirect URL is not supported for popup mode");if(i==="window"&&!s)throw new Error("Redirect URL is required for window mode");const o=H(t);let r=`${d("inAppWallet")}/api/2024-05-05/login/${o}?clientId=${e.clientId}`;if(n?.partnerId?r=`${r}&ecosystemId=${n.id}&ecosystemPartnerId=${n.partnerId}`:n&&(r=`${r}&ecosystemId=${n.id}`),i!=="popup"){const a=new URL(s||window.location.href);a.searchParams.set("walletId",n?.id||"inApp"),a.searchParams.set("authProvider",t),r=`${r}&redirectUrl=${encodeURIComponent(a.toString())}`}return r},O=({authOption:t,client:e,ecosystem:n})=>{const i=H(t);let s=`${d("inAppWallet")}/api/2024-05-05/login/${i}/callback?clientId=${e.clientId}`;return n?.partnerId?s=`${s}&ecosystemId=${n.id}&ecosystemPartnerId=${n.partnerId}`:n&&(s=`${s}&ecosystemId=${n.id}`),s},se="width=350, height=500",F=({isWindowOpenedByFn:t,win:e,closeOpenedWindow:n})=>{t?e?.close():e&&n?n(e):e&&e.close()};async function re(t){const e=I({...t,mode:t.mode||"redirect"});t.mode==="redirect"?window.location.href=e:window.open(e),await new Promise(n=>setTimeout(n,5e3))}const oe=async t=>{let e=t.openedWindow,n=!1;if(e||(e=window.open(I({...t,mode:"popup"}),`Login to ${t.authOption}`,se),n=!0),!e)throw new Error("Something went wrong opening pop-up");return await new Promise((s,o)=>{const r=window.setInterval(async()=>{e.closed&&(clearInterval(r),window.removeEventListener("message",a),o(new Error("User closed login window")))},1e3),a=async l=>{if(l.origin===d("inAppWallet")){if(typeof l.data!="object"){o(new Error("Invalid event data"));return}switch(l.data.eventType){case"oauthSuccessResult":{window.removeEventListener("message",a),clearInterval(r),F({closeOpenedWindow:t.closeOpenedWindow,isWindowOpenedByFn:n,win:e}),l.data.authResult&&s(l.data.authResult);break}case"oauthFailureResult":{window.removeEventListener("message",a),clearInterval(r),F({closeOpenedWindow:t.closeOpenedWindow,isWindowOpenedByFn:n,win:e}),o(new Error(l.data.errorString));break}}}};window.addEventListener("message",a)})},L=new Map,ce={getItem:async t=>L.get(t)??null,removeItem:async t=>{L.delete(t)},setItem:async(t,e)=>{L.set(t,e)}};async function C({authToken:t,client:e,ecosystem:n}){const s=await h(e,n)(`${d("inAppWallet")}/api/2024-05-05/accounts`,{headers:{Authorization:`Bearer embedded-wallet-token:${t}`,"Content-Type":"application/json"},method:"GET"});if(!s.ok){const o=await s.text().catch(()=>"Unknown error");throw new Error(`Failed to get user info: ${o}`)}return await s.json()}const le=d("inAppWallet"),ue=`${le}/`,V=`${ue}api/2023-10-20`,de=`${V}/embedded-wallet/validate-custom-jwt`,he=`${V}/embedded-wallet/validate-custom-auth-endpoint`,q=(t,e)=>e instanceof Error?`${t}: ${e.message}`:`${t}: ${w(e)}`;async function we(t){const n=await h(t.client,t.ecosystem)(he,{body:w({developerClientId:t.client.clientId,payload:t.payload}),headers:{"Content-Type":"application/json"},method:"POST"});if(!n.ok){const i=await n.json();throw new Error(`Custom auth endpoint authentication error: ${i.message}`)}try{const{verifiedToken:i}=await n.json();return{storedToken:i}}catch(i){throw new Error(q("Malformed response from post auth_endpoint authentication",i))}}async function pe(t){const e=h(t.client,t.ecosystem),n=I({authOption:"backend",client:t.client,ecosystem:t.ecosystem}),i=await e(`${n}`,{body:w({walletSecret:t.walletSecret}),headers:{"Content-Type":"application/json"},method:"POST"});if(!i.ok){const s=await i.text();throw new Error(`Failed to generate backend account: ${s}`)}return await i.json()}async function ge(t){let e=await t.storage.getGuestSessionId();e||(e=ee(32),t.storage.saveGuestSessionId(e));const n=h(t.client,t.ecosystem),i=O({authOption:"guest",client:t.client,ecosystem:t.ecosystem}),s=await n(`${i}`,{body:w({sessionId:e}),headers:{"Content-Type":"application/json"},method:"POST"});if(!s.ok){const o=await s.text();throw new Error(`Failed to generate guest account: ${s.status} ${s.statusText} ${o}`)}return await s.json()}async function me(t){const n=await h(t.client,t.ecosystem)(de,{body:w({developerClientId:t.client.clientId,jwt:t.jwt}),headers:{"Content-Type":"application/json"},method:"POST"});if(!n.ok){const i=await n.json();throw new Error(`JWT authentication error: ${i.message}`)}try{const{verifiedToken:i}=await n.json();return{storedToken:i}}catch(i){throw new Error(q("Malformed response from post jwt authentication",i))}}async function ye({client:t,ecosystem:e,tokenToLink:n,storage:i}){const s=h(t,e),o=d("inAppWallet"),r=await i.getAuthCookie();if(!r)throw new Error("Failed to link account, no user logged in");const a={Authorization:`Bearer iaw-auth-token:${r}`,"Content-Type":"application/json"},l=await s(`${o}/api/2024-05-05/account/connect`,{body:w({accountAuthTokenToConnect:n}),headers:a,method:"POST"});if(!l.ok){const u=await l.json();throw new Error(u.message||"Failed to link account.")}const{linkedAccounts:c}=await l.json();return c??[]}async function fe({client:t,ecosystem:e,profileToUnlink:n,allowAccountDeletion:i=!1,storage:s}){const o=h(t,e),r=d("inAppWallet"),a=await s.getAuthCookie();if(!a)throw new Error("Failed to unlink account, no user logged in");const l={Authorization:`Bearer iaw-auth-token:${a}`,"Content-Type":"application/json"},c=await o(`${r}/api/2024-05-05/account/disconnect`,{body:w({allowAccountDeletion:i,details:n.details,type:n.type}),headers:l,method:"POST"});if(!c.ok){const p=await c.json();throw new Error(p.message||"Failed to unlink account.")}const{linkedAccounts:u}=await c.json();return u??[]}async function be({client:t,ecosystem:e,storage:n}){const i=h(t,e),s=d("inAppWallet"),o=await n.getAuthCookie();if(!o)throw new Error("Failed to get linked accounts, no user logged in");const r={Authorization:`Bearer iaw-auth-token:${o}`,"Content-Type":"application/json"},a=await i(`${s}/api/2024-05-05/accounts`,{headers:r,method:"GET"});if(!a.ok){const c=await a.json();throw new Error(c.message||"Failed to get linked accounts.")}const{linkedAccounts:l}=await a.json();return l??[]}function Q(){return`${d("inAppWallet")}/api/2024-05-05/login/passkey/callback`}function J(t,e){return`${d("inAppWallet")}/api/2024-05-05/login/passkey?type=${t}${e?`&username=${e}`:""}`}async function Ie(t){if(!t.passkeyClient.isAvailable())throw new Error("Passkeys are not available on this device");const e=h(t.client,t.ecosystem),n=t.username??ve(t.ecosystem),s=await(await e(J("sign-up",n))).json();if(!s.challenge)throw new Error("No challenge received");const o=s.challenge,r=await t.passkeyClient.register({challenge:o,name:n,rp:t.rp}),a={};t.ecosystem?.partnerId&&(a["x-ecosystem-partner-id"]=t.ecosystem.partnerId),t.ecosystem?.id&&(a["x-ecosystem-id"]=t.ecosystem.id);const c=await(await e(Q(),{body:w({authenticatorData:r.authenticatorData,clientData:r.clientData,credential:{algorithm:r.credential.algorithm,publicKey:r.credential.publicKey},credentialId:r.credentialId,origin:r.origin,rpId:t.rp.id,serverVerificationId:s.serverVerificationId,type:"sign-up",username:n}),headers:{"Content-Type":"application/json",...a},method:"POST"})).json();if(!c||!c.storedToken)throw new Error(`Error verifying passkey: ${c.message??"unknown error"}`);return await t.storage?.savePasskeyCredentialId(r.credentialId),c}async function ke(t){if(!t.passkeyClient.isAvailable())throw new Error("Passkeys are not available on this device");const e=h(t.client,t.ecosystem),[n,i]=await Promise.all([e(J("sign-in")).then(c=>c.json()),t.storage?.getPasskeyCredentialId()]);if(!n.challenge)throw new Error("No challenge received");const s=n.challenge,o=await t.passkeyClient.authenticate({challenge:s,credentialId:i??void 0,rp:t.rp}),r={};t.ecosystem?.partnerId&&(r["x-ecosystem-partner-id"]=t.ecosystem.partnerId),t.ecosystem?.id&&(r["x-ecosystem-id"]=t.ecosystem.id);const l=await(await e(Q(),{body:w({authenticatorData:o.authenticatorData,clientData:o.clientData,credentialId:o.credentialId,origin:o.origin,rpId:t.rp.id,serverVerificationId:n.serverVerificationId,signature:o.signature,type:"sign-in"}),headers:{"Content-Type":"application/json",...r},method:"POST"})).json();if(!l||!l.storedToken)throw new Error(`Error verifying passkey: ${l.message??"unknown error"}`);return await t.storage?.savePasskeyCredentialId(o.credentialId),l}function ve(t){return`${t?.id??"wallet"}-${new Date().toISOString()}`}function Ae(t){let i=[`${t.domain} wants you to sign in with your Ethereum account:`,t.address].join(`
`);i=[i,t.statement].join(`

`),t.statement&&(i+=`
`);const s=[];if(t.uri){const u=`URI: ${t.uri}`;s.push(u)}const o=`Version: ${t.version}`;if(s.push(o),t.chain_id){const u=`Chain ID: ${t.chain_id}`||"1";s.push(u)}const r=`Nonce: ${t.nonce}`;s.push(r);const a=`Issued At: ${t.issued_at}`;s.push(a);const l=`Expiration Time: ${t.expiration_time}`;if(s.push(l),t.invalid_before){const u=`Not Before: ${t.invalid_before}`;s.push(u)}t.resources&&s.push(["Resources:",...t.resources.map(u=>`- ${u}`)].join(`
`));const c=s.join(`
`);return[i,c].join(`
`)}async function Te(t){const{payload:e,account:n}=t,i=await n.signMessage({message:Ae(e)});return{payload:e,signature:i}}const Ee=["xyz.abs"];async function Le(t){const{wallet:e,client:n,ecosystem:i,chain:s}=t,o=Ee.includes(e.id)?s||b(1):b(1),r=e.getAccount()||await e.connect({chain:o,client:n}),a=h(n,i),l=await(async()=>{const p=I({authOption:"wallet",client:t.client,ecosystem:t.ecosystem}),g=await a(`${p}&address=${r.address}&chainId=${o.id}`);if(!g.ok)throw new Error("Failed to generate SIWE login payload");return await g.json()})(),{signature:c}=await Te({account:r,payload:l});return await(async()=>{const p=O({authOption:"wallet",client:t.client,ecosystem:t.ecosystem}),g=await a(`${p}&signature=${c}&payload=${encodeURIComponent(l)}`,{body:w({payload:l,signature:c}),headers:{"Content-Type":"application/json"},method:"POST"});if(!g.ok)throw new Error("Failed to verify SIWE signature");return await g.json()})()}async function Se({client:t,payload:e,storage:n}){const i=await n.getAuthCookie(),s=n.ecosystem,o=h(t,s);if(!i)throw new Error("No auth token found when signing message");const r={address:e.address,chainId:e.chainId,nonce:Number(e.nonce)},a=await o(`${d("inAppWallet")}/api/v1/enclave-wallet/sign-authorization`,{body:w(r),headers:{Authorization:`Bearer embedded-wallet-token:${i}`,"Content-Type":"application/json","x-thirdweb-client-id":t.clientId},method:"POST"});if(!a.ok)throw new Error(`Failed to sign message - ${a.status} ${a.statusText}`);return await a.json()}async function Pe({client:t,payload:{message:e,isRaw:n,originalMessage:i,chainId:s},storage:o}){const r=await o.getAuthCookie(),a=o.ecosystem,l=h(t,a);if(!r)throw new Error("No auth token found when signing message");const c=await l(`${d("inAppWallet")}/api/v1/enclave-wallet/sign-message`,{body:w({messagePayload:{chainId:s,isRaw:n,message:e,originalMessage:i}}),headers:{Authorization:`Bearer embedded-wallet-token:${r}`,"Content-Type":"application/json","x-thirdweb-client-id":t.clientId},method:"POST"});if(!c.ok)throw new Error(`Failed to sign message - ${c.status} ${c.statusText}`);return await c.json()}async function We({client:t,payload:e,storage:n}){const i=await n.getAuthCookie(),s=n.ecosystem,o=h(t,s);if(!i)throw new Error("No auth token found when signing transaction");const r=await o(`${d("inAppWallet")}/api/v1/enclave-wallet/sign-transaction`,{body:w({transactionPayload:e}),headers:{Authorization:`Bearer embedded-wallet-token:${i}`,"Content-Type":"application/json","x-thirdweb-client-id":t.clientId},method:"POST"});if(!r.ok)throw new Error(`Failed to sign transaction - ${r.status} ${r.statusText}`);return(await r.json()).signature}async function Oe({client:t,payload:e,storage:n}){const i=await n.getAuthCookie(),s=n.ecosystem,o=h(t,s);if(!i)throw new Error("No auth token found when signing typed data");const r=await o(`${d("inAppWallet")}/api/v1/enclave-wallet/sign-typed-data`,{body:w({...e}),headers:{Authorization:`Bearer embedded-wallet-token:${i}`,"Content-Type":"application/json","x-thirdweb-client-id":t.clientId},method:"POST"});if(!r.ok)throw new Error(`Failed to sign typed data - ${r.status} ${r.statusText}`);return await r.json()}class Ce{constructor({client:e,ecosystem:n,address:i,storage:s}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"address",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=n,this.address=i,this.localStorage=s}async postWalletSetUp(e){await this.localStorage.saveAuthCookie(e.storedToken.cookieString)}async getUserWalletStatus(){const e=await this.localStorage.getAuthCookie();if(!e)return{status:"Logged Out"};const n=await C({authToken:e,client:this.client,ecosystem:this.ecosystem});if(!n)return{status:"Logged Out"};const i=n.wallets[0],s={email:n.linkedAccounts.find(o=>o.details.email!==void 0)?.details.email,phoneNumber:n.linkedAccounts.find(o=>o.details.phone!==void 0)?.details.phone,recoveryShareManagement:"ENCLAVE",userWalletId:n.id||""};return i?{account:await this.getAccount(),authDetails:s,status:"Logged In, Wallet Initialized",walletAddress:i.address}:{authDetails:s,status:"Logged In, Wallet Uninitialized"}}async getAccount(){const e=this.client,n=this.localStorage,i=this.address,s=this.ecosystem,o=async a=>{const l=P({chain:b(a.chainId),client:e}),c={chainId:W(a.chainId),data:a.data,gas:m(a.gas),nonce:m(a.nonce)||W(await k(async()=>{const{eth_getTransactionCount:u}=await import("./eth_getTransactionCount-DhE6m_ss.js");return{eth_getTransactionCount:u}},__vite__mapDeps([0,1,2])).then(({eth_getTransactionCount:u})=>u(l,{address:f(this.address),blockTag:"pending"}))),to:a.to?f(a.to):void 0,value:m(a.value)};return a.authorizationList&&a.authorizationList.length>0?(c.type=4,c.authorizationList=a.authorizationList,c.maxFeePerGas=m(a.maxFeePerGas),c.maxPriorityFeePerGas=m(a.maxPriorityFeePerGas)):m(a.maxFeePerGas)?(c.maxFeePerGas=m(a.maxFeePerGas),c.maxPriorityFeePerGas=m(a.maxPriorityFeePerGas),c.type=2):(c.gasPrice=m(a.gasPrice),c.type=0),We({client:e,payload:c,storage:n})},r={address:f(i),async sendTransaction(a){const l=P({chain:b(a.chainId),client:e}),c=await o(a),u=await G(l,c);return M({chainId:a.chainId,client:e,contractAddress:a.to??void 0,ecosystem:s,gasPrice:a.gasPrice,transactionHash:u,walletAddress:i,walletType:"inApp"}),{transactionHash:u}},async signAuthorization(a){const l=await Se({client:e,payload:a,storage:n});return{address:f(l.address),chainId:Number.parseInt(l.chainId),nonce:BigInt(l.nonce),r:BigInt(l.r),s:BigInt(l.s),yParity:Number.parseInt(l.yParity)}},async signMessage({message:a,originalMessage:l,chainId:c}){const u=typeof a=="string"?{chainId:c,isRaw:!1,message:a,originalMessage:l}:{chainId:c,isRaw:!0,message:typeof a.raw=="string"?a.raw:K(a.raw),originalMessage:l},{signature:p}=await Pe({client:e,payload:u,storage:n});return p},async signTransaction(a){if(!a.chainId)throw new Error("chainId required in tx to sign");return o({chainId:a.chainId,...a})},async signTypedData(a){const l=B(a),{signature:c}=await Oe({client:e,payload:l,storage:n});return c},sendCalls:async a=>{const{inAppWalletSendCalls:l}=await k(async()=>{const{inAppWalletSendCalls:y}=await import("./in-app-wallet-calls-Bu1gU1-o.js");return{inAppWalletSendCalls:y}},__vite__mapDeps([3,1,2,4,5,6])),c=a.calls[0];if(!c)throw new Error("No calls to send");const u=c.client,p=c.chain||a.chain,g=await l({account:r,calls:a.calls,chain:p});return{chain:p,client:u,id:g}},getCallsStatus:async a=>{const{inAppWalletGetCallsStatus:l}=await k(async()=>{const{inAppWalletGetCallsStatus:c}=await import("./in-app-wallet-calls-Bu1gU1-o.js");return{inAppWalletGetCallsStatus:c}},__vite__mapDeps([3,1,2,4,5,6]));return l(a)},getCapabilities:async a=>({[a.chainId??1]:{atomic:{status:"unsupported"},paymasterService:{supported:!1}}})};return r}}function m(t){return t===void 0||Y(t)?t:W(t)}const _e={backgroundColor:"transparent",border:"none",colorScheme:"light",display:"none",height:"100%",pointerEvents:"all",position:"fixed",right:"0px",top:"0px",width:"100%",zIndex:"2147483646"},S=new Map;class $e{constructor({link:e,baseUrl:n,iframeId:i,container:s,onIframeInitialize:o,localStorage:r,clientId:a,ecosystem:l}){if(Object.defineProperty(this,"iframe",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"POLLING_INTERVAL_SECONDS",{enumerable:!0,configurable:!0,writable:!0,value:1.4}),Object.defineProperty(this,"iframeBaseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.localStorage=r,this.clientId=a,this.ecosystem=l,this.iframeBaseUrl=n,typeof document>"u")return;s=s??document.body;let c=document.getElementById(i);const u=new URL(e);if(!c||c.src!==u.href){c=document.createElement("iframe");const p={..._e};Object.assign(c.style,p),c.setAttribute("id",i),c.setAttribute("fetchpriority","high"),s.appendChild(c),c.src=u.href;const g=y=>{if(y.data.eventType==="ewsIframeLoaded"){if(window.removeEventListener("message",g),!c){console.warn("thirdweb iFrame not found");return}this.onIframeLoadHandler(c,o)()}};window.addEventListener("message",g)}this.iframe=c}async onIframeLoadedInitVariables(){return{authCookie:await this.localStorage.getAuthCookie(),clientId:this.clientId,deviceShareStored:await this.localStorage.getDeviceShare(),ecosystemId:this.ecosystem?.id,partnerId:this.ecosystem?.partnerId,walletUserId:await this.localStorage.getWalletUserId()}}onIframeLoadHandler(e,n){return async()=>{const i=new MessageChannel,s=new Promise((o,r)=>{i.port1.onmessage=a=>{const{data:l}=a;i.port1.close(),l.success||r(new Error(l.error)),S.set(e.src,!0),n&&n(),o(!0)}});e?.contentWindow?.postMessage({data:await this.onIframeLoadedInitVariables(),eventType:"initIframe"},this.iframeBaseUrl,[i.port2]),await s}}async call({procedureName:e,params:n,showIframe:i=!1}){if(!this.iframe)throw new Error("Iframe not found. You are likely calling this from the backend where the DOM is not available.");for(;!S.get(this.iframe.src);)await v(this.POLLING_INTERVAL_SECONDS*1e3);i&&(this.iframe.style.display="block",await v(.005*1e3));const s=new MessageChannel,o=new Promise((r,a)=>{s.port1.onmessage=async l=>{const{data:c}=l;s.port1.close(),i&&(await v(.1*1e3),this.iframe&&(this.iframe.style.display="none")),c.success?r(c.data):a(new Error(c.error))}});return this.iframe.contentWindow?.postMessage({data:{...n,...await this.onIframeLoadedInitVariables()},eventType:e},this.iframeBaseUrl,[s.port2]),o}destroy(){this.iframe&&S.delete(this.iframe.src)}}class je extends $e{constructor({clientId:e,baseUrl:n,ecosystem:i}){super({baseUrl:n,clientId:e,container:typeof document>"u"?void 0:document.body,ecosystem:i,iframeId:Ue+(i?.id||""),link:De({baseUrl:n,clientId:e,ecosystem:i,path:te}).href,localStorage:new x({clientId:e,ecosystem:i,storage:z})}),this.clientId=e,this.ecosystem=i}}function De({clientId:t,baseUrl:e,path:n,ecosystem:i,queryParams:s}){const o=new URL(`${n}`,e);if(s)for(const r of Object.keys(s))o.searchParams.set(r,s[r]?.toString()||"");return o.searchParams.set("clientId",t),i?.partnerId!==void 0&&o.searchParams.set("partnerId",i.partnerId),i?.id!==void 0&&o.searchParams.set("ecosystemId",i.id),o}const Ue="thirdweb-in-app-wallet-iframe";async function Fe({client:t,ecosystem:e,authToken:n}){const s=await h(t,e)(`${d("inAppWallet")}/api/v1/enclave-wallet/generate`,{headers:{Authorization:`Bearer embedded-wallet-token:${n}`,"Content-Type":"application/json","x-thirdweb-client-id":t.clientId},method:"POST"});if(!s.ok)throw new Error(`Failed to generate wallet - ${s.status} ${s.statusText}`);const{wallet:o}=await s.json();return o}class Ne{constructor({baseUrl:e,querier:n,preLogin:i,postLogin:s,client:o,ecosystem:r}){Object.defineProperty(this,"LoginQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"preLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"postLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"baseUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.baseUrl=e,this.LoginQuerier=n,this.preLogin=i,this.postLogin=s,this.client=o,this.ecosystem=r}async sendEmailLoginOtp({email:e}){return await this.LoginQuerier.call({params:{email:e},procedureName:"sendThirdwebEmailLoginOtp"})}async sendSmsLoginOtp({phoneNumber:e}){return await this.LoginQuerier.call({params:{phoneNumber:e},procedureName:"sendThirdwebSmsLoginOtp"})}}class Re extends Ne{async authenticateWithModal(){return this.LoginQuerier.call({params:void 0,procedureName:"loginWithThirdwebModal",showIframe:!0})}async loginWithModal(){await this.preLogin();const e=await this.authenticateWithModal();return this.postLogin(e)}async authenticateWithIframe({email:e}){return this.LoginQuerier.call({params:{email:e},procedureName:"loginWithThirdwebModal",showIframe:!0})}async loginWithIframe({email:e}){await this.preLogin();const n=await this.authenticateWithIframe({email:e});return this.postLogin(n)}async authenticateWithCustomJwt({encryptionKey:e,jwt:n}){if(!e||e.length===0)throw new Error("Encryption key is required for custom jwt auth");return this.LoginQuerier.call({params:{encryptionKey:e,jwt:n},procedureName:"loginWithCustomJwt"})}async loginWithCustomJwt({encryptionKey:e,jwt:n}){if(!e||e.length===0)throw new Error("Encryption key is required for custom jwt auth");await this.preLogin();const i=await this.authenticateWithCustomJwt({encryptionKey:e,jwt:n});return this.postLogin(i)}async authenticateWithCustomAuthEndpoint({encryptionKey:e,payload:n}){return this.LoginQuerier.call({params:{encryptionKey:e,payload:n},procedureName:"loginWithCustomAuthEndpoint"})}async loginWithCustomAuthEndpoint({encryptionKey:e,payload:n}){if(!e||e.length===0)throw new Error("Encryption key is required for custom auth");await this.preLogin();const i=await this.authenticateWithCustomAuthEndpoint({encryptionKey:e,payload:n});return this.postLogin(i)}async authenticateWithEmailOtp({email:e,otp:n,recoveryCode:i}){return this.LoginQuerier.call({params:{email:e,otp:n,recoveryCode:i},procedureName:"verifyThirdwebEmailLoginOtp"})}async loginWithEmailOtp({email:e,otp:n,recoveryCode:i}){const s=await this.authenticateWithEmailOtp({email:e,otp:n,recoveryCode:i});return this.postLogin(s)}async authenticateWithSmsOtp({phoneNumber:e,otp:n,recoveryCode:i}){return this.LoginQuerier.call({params:{otp:n,phoneNumber:e,recoveryCode:i},procedureName:"verifyThirdwebSmsLoginOtp"})}async loginWithSmsOtp({phoneNumber:e,otp:n,recoveryCode:i}){const s=await this.authenticateWithSmsOtp({otp:n,phoneNumber:e,recoveryCode:i});return this.postLogin(s)}}class Be{constructor({client:e,querier:n,onAuthSuccess:i,ecosystem:s,baseUrl:o,localStorage:r}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"AuthQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onAuthSuccess",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"BaseLogin",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=s,this.AuthQuerier=n,this.localStorage=r,this.onAuthSuccess=i,this.BaseLogin=new Re({baseUrl:o,client:e,ecosystem:s,postLogin:async a=>this.postLogin(a),preLogin:async()=>{await this.preLogin()},querier:n})}async preLogin(){await this.logout()}async postLogin({storedToken:e,walletDetails:n}){return e.shouldStoreCookieString&&await this.localStorage.saveAuthCookie(e.cookieString),await this.onAuthSuccess({storedToken:e,walletDetails:n})}async loginWithAuthToken(e,n){e.storedToken.authProvider!=="Backend"&&await this.preLogin();const i=await C({authToken:e.storedToken.cookieString,client:this.client,ecosystem:this.ecosystem});if(!i)throw new Error("Cannot login, no user found for auth token");if(i.wallets.length>0&&i.wallets[0]?.type==="enclave")return this.postLogin({storedToken:e.storedToken,walletDetails:{walletAddress:i.wallets[0].address}});if(i.wallets.length===0){const o=await Fe({authToken:e.storedToken.cookieString,client:this.client,ecosystem:this.ecosystem});return this.postLogin({storedToken:e.storedToken,walletDetails:{walletAddress:o.address}})}const s=await this.AuthQuerier.call({params:{recoveryCode:n,storedToken:e.storedToken},procedureName:"loginWithStoredTokenDetails"});return this.postLogin(s)}async loginWithModal(){return this.BaseLogin.loginWithModal()}async authenticateWithModal(){return this.BaseLogin.authenticateWithModal()}async loginWithIframe(e){return this.BaseLogin.loginWithIframe(e)}async authenticateWithIframe(e){return this.BaseLogin.authenticateWithIframe(e)}async loginWithCustomJwt(e){return this.BaseLogin.loginWithCustomJwt(e)}async authenticateWithCustomJwt(e){return this.BaseLogin.authenticateWithCustomJwt(e)}async loginWithCustomAuthEndpoint(e){return this.BaseLogin.loginWithCustomAuthEndpoint(e)}async authenticateWithCustomAuthEndpoint(e){return this.BaseLogin.authenticateWithCustomAuthEndpoint(e)}async sendEmailLoginOtp({email:e}){return this.BaseLogin.sendEmailLoginOtp({email:e})}async sendSmsLoginOtp({phoneNumber:e}){return this.BaseLogin.sendSmsLoginOtp({phoneNumber:e})}async loginWithEmailOtp(e){return await this.preLogin(),this.BaseLogin.loginWithEmailOtp(e)}async authenticateWithEmailOtp(e){return this.BaseLogin.authenticateWithEmailOtp(e)}async loginWithSmsOtp(e){return await this.preLogin(),this.BaseLogin.loginWithSmsOtp(e)}async authenticateWithSmsOtp(e){return this.BaseLogin.authenticateWithSmsOtp(e)}async logout(){const e=await this.localStorage.removeAuthCookie(),n=await this.localStorage.removeWalletUserId();return{success:e||n}}}const Me=async t=>{const{client:e,ecosystem:n}=t,i=I({authOption:t.strategy,client:e,ecosystem:n}),s={"Content-Type":"application/json","x-client-id":e.clientId};n?.id&&(s["x-ecosystem-id"]=n.id),n?.partnerId&&(s["x-ecosystem-partner-id"]=n.partnerId);const o=(()=>{switch(t.strategy){case"email":return{email:t.email};case"phone":return{phone:t.phoneNumber}}})(),r=await fetch(i,{body:w(o),headers:s,method:"POST"});if(!r.ok)throw new Error("Failed to send verification code");return await r.json()},N=async t=>{const{client:e,ecosystem:n}=t,i=O({authOption:t.strategy,client:t.client,ecosystem:t.ecosystem}),s={"Content-Type":"application/json","x-client-id":e.clientId};n?.id&&(s["x-ecosystem-id"]=n.id),n?.partnerId&&(s["x-ecosystem-partner-id"]=n.partnerId);const o=(()=>{switch(t.strategy){case"email":return{code:t.verificationCode,email:t.email};case"phone":return{code:t.verificationCode,phone:t.phoneNumber}}})(),r=await fetch(i,{body:w(o),headers:s,method:"POST"});if(!r.ok)throw new Error("Failed to verify verification code");return await r.json()};class R{constructor({client:e,ecosystem:n,querier:i,localStorage:s}){Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"walletManagerQuerier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"localStorage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.client=e,this.ecosystem=n,this.walletManagerQuerier=i,this.localStorage=s}async postWalletSetUp(e){e.deviceShareStored&&await this.localStorage.saveDeviceShare(e.deviceShareStored,e.storedToken.authDetails.userWalletId)}async getUserWalletStatus(){const e=await this.walletManagerQuerier.call({params:void 0,procedureName:"getUserStatus"});return e.status==="Logged In, Wallet Initialized"?{status:"Logged In, Wallet Initialized",...e.user,account:await this.getAccount()}:e.status==="Logged In, New Device"?{status:"Logged In, New Device",...e.user}:e.status==="Logged In, Wallet Uninitialized"?{status:"Logged In, Wallet Uninitialized",...e.user}:{status:e.status}}async getAccount(){const e=this.walletManagerQuerier,n=this.client,i=this.ecosystem?.partnerId,{address:s}=await e.call({params:void 0,procedureName:"getAddress"}),o=async r=>{const a={chainId:r.chainId,data:r.data,gasLimit:r.gas,nonce:r.nonce,to:r.to??void 0,value:r.value};r.maxFeePerGas?(a.accessList=r.accessList,a.maxFeePerGas=r.maxFeePerGas,a.maxPriorityFeePerGas=r.maxPriorityFeePerGas,a.type=2):(a.gasPrice=r.gasPrice,a.type=0);const l=_().rpc,{signedTransaction:c}=await e.call({params:{chainId:r.chainId,partnerId:i,rpcEndpoint:`https://${r.chainId}.${l}`,transaction:a},procedureName:"signTransaction"});return c};return{address:f(s),async sendTransaction(r){const a=P({chain:b(r.chainId),client:n}),l=await o(r),c=await G(a,l);return M({chainId:r.chainId,client:n,contractAddress:r.to??void 0,gasPrice:r.gasPrice,transactionHash:c,walletAddress:s,walletType:"inApp"}),{transactionHash:c}},async signMessage({message:r}){const a=typeof r=="string"?r:r.raw instanceof Uint8Array?r.raw:X(r.raw),{signedMessage:l}=await e.call({params:{chainId:1,message:a,partnerId:i},procedureName:"signMessage"});return l},async signTransaction(r){if(!r.chainId)throw new Error("chainId required in tx to sign");return o({...r,chainId:r.chainId})},async signTypedData(r){const a=B(r);a.types?.EIP712Domain&&(a.types.EIP712Domain=void 0);const l=a.domain,c=l?.chainId,p={...l?.verifyingContract?{verifyingContract:l?.verifyingContract}:{},name:l?.name,version:l?.version};c&&(p.chainId=c);const g=_().rpc,{signedTypedData:y}=await e.call({params:{chainId:Number.parseInt(BigInt(c||1).toString()),domain:p,message:a.message,partnerId:i,rpcEndpoint:`https://${c}.${g}`,types:a.types},procedureName:"signTypedDataV4"});return y}}}}class Qe{isClientIdLegacyPaper(e){return e.indexOf("-")>0&&e.length===36}constructor({client:e,onAuthSuccess:n,ecosystem:i,passkeyDomain:s,storage:o}){if(Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ecosystem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"querier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"storage",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"wallet",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"auth",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"passkeyDomain",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.isClientIdLegacyPaper(e.clientId))throw new Error("You are using a legacy clientId. Please use the clientId found on the thirdweb dashboard settings page");const r=d("inAppWallet");this.client=e,this.ecosystem=i,this.passkeyDomain=s,this.storage=new x({clientId:e.clientId,ecosystem:i,storage:o??Ge()}),this.querier=new je({baseUrl:r,clientId:e.clientId,ecosystem:i}),this.auth=new Be({baseUrl:r,client:e,ecosystem:i,localStorage:this.storage,onAuthSuccess:async a=>{if(n?.(a),a.storedToken.authDetails.walletType==="sharded"&&(await this.querier.call({params:{storedToken:a.storedToken},procedureName:"migrateFromShardToEnclave"})||console.warn("Failed to migrate from sharded to enclave wallet, continuing with sharded wallet")),this.wallet=await this.initializeWallet(a.storedToken.cookieString),!this.wallet)throw new Error("Failed to initialize wallet");const l="deviceShareStored"in a.walletDetails?a.walletDetails.deviceShareStored:void 0;return await this.wallet.postWalletSetUp({deviceShareStored:l,storedToken:a.storedToken}),this.wallet instanceof R&&await this.querier.call({params:{authCookie:a.storedToken.cookieString,clientId:this.client.clientId,deviceShareStored:"deviceShareStored"in a.walletDetails?a.walletDetails.deviceShareStored:null,ecosystemId:i?.id,partnerId:i?.partnerId,walletUserId:a.storedToken.authDetails.userWalletId},procedureName:"initIframe"}),{user:{account:await this.wallet.getAccount(),authDetails:a.storedToken.authDetails,status:"Logged In, Wallet Initialized",walletAddress:a.walletDetails.walletAddress}}},querier:this.querier})}async initializeWallet(e){const n=await this.storage.getAuthCookie();if(!e&&n===null)throw new Error("No auth token provided and no stored auth token found to initialize the wallet");const i=await C({authToken:e||n,client:this.client,ecosystem:this.ecosystem});if(!i)throw new Error("Cannot initialize wallet, no user logged in");if(i.wallets.length===0)throw new Error("Cannot initialize wallet, this user does not have a wallet generated yet");return i.wallets[0]?.type==="enclave"?new Ce({address:i.wallets[0].address,client:this.client,ecosystem:this.ecosystem,storage:this.storage}):new R({client:this.client,ecosystem:this.ecosystem,localStorage:this.storage,querier:this.querier})}async getUser(){if(!this.wallet){const e=await this.storage.getAuthCookie();if(!e)return{status:"Logged Out"};this.wallet=await this.initializeWallet(e)}if(!this.wallet)throw new Error("Wallet not initialized");return await this.wallet.getUserWalletStatus()}getAccount(){if(!this.wallet)throw new Error("Wallet not initialized");return this.wallet.getAccount()}async preAuthenticate(e){return Me({...e,client:this.client,ecosystem:this.ecosystem})}async authenticateWithRedirect(e,n,i){return re({authOption:e,client:this.client,ecosystem:this.ecosystem,mode:n,redirectUrl:i})}async loginWithAuthToken(e,n){return this.auth.loginWithAuthToken(e,n)}async authenticate(e){const n=e.strategy;switch(n){case"email":return N({...e,client:this.client,ecosystem:this.ecosystem});case"phone":return N({...e,client:this.client,ecosystem:this.ecosystem});case"auth_endpoint":return we({client:this.client,ecosystem:this.ecosystem,payload:e.payload});case"jwt":return me({client:this.client,ecosystem:this.ecosystem,jwt:e.jwt});case"passkey":return this.passkeyAuth(e);case"iframe_email_verification":return this.auth.authenticateWithIframe({email:e.email});case"iframe":return this.auth.authenticateWithModal();case"apple":case"facebook":case"google":case"telegram":case"github":case"twitch":case"farcaster":case"line":case"x":case"tiktok":case"epic":case"steam":case"coinbase":case"discord":return oe({authOption:n,client:this.client,closeOpenedWindow:e.closeOpenedWindow,ecosystem:this.ecosystem,openedWindow:e.openedWindow});case"guest":return ge({client:this.client,ecosystem:this.ecosystem,storage:this.storage});case"backend":return pe({client:this.client,ecosystem:this.ecosystem,walletSecret:e.walletSecret});case"wallet":return Le({client:this.client,ecosystem:this.ecosystem,wallet:e.wallet,chain:e.chain})}}async connect(e){const n=e.strategy;switch(n){case"auth_endpoint":case"jwt":{const i=await this.authenticate(e);return await this.loginWithAuthToken(i,e.encryptionKey)}case"iframe_email_verification":return this.auth.loginWithIframe({email:e.email});case"iframe":return this.auth.loginWithModal();case"passkey":{const i=await this.passkeyAuth(e);return this.loginWithAuthToken(i)}case"backend":case"phone":case"email":case"wallet":case"apple":case"facebook":case"google":case"farcaster":case"telegram":case"github":case"line":case"x":case"tiktok":case"epic":case"guest":case"coinbase":case"twitch":case"steam":case"discord":{const i=await this.authenticate(e);return await this.auth.loginWithAuthToken(i)}default:ze(n)}}async logout(){return await this.auth.logout()}async passkeyAuth(e){const{PasskeyWebClient:n}=await k(async()=>{const{PasskeyWebClient:a}=await import("./passkeys-CeYaPhsJ.js");return{PasskeyWebClient:a}},[]),{passkeyName:i,storeLastUsedPasskey:s=!0}=e,o=new n,r=this.storage;return e.type==="sign-up"?Ie({client:this.client,ecosystem:this.ecosystem,passkeyClient:o,rp:{id:this.passkeyDomain??window.location.hostname,name:this.passkeyDomain??window.document.title},storage:s?r:void 0,username:i}):ke({client:this.client,ecosystem:this.ecosystem,passkeyClient:o,rp:{id:this.passkeyDomain??window.location.hostname,name:this.passkeyDomain??window.document.title},storage:s?r:void 0})}async linkProfile(e){const{storedToken:n}=await this.authenticate(e);return await ye({client:e.client,ecosystem:e.ecosystem||this.ecosystem,storage:this.storage,tokenToLink:n.cookieString})}async unlinkProfile(e,n){return await fe({allowAccountDeletion:n,client:this.client,ecosystem:this.ecosystem,profileToUnlink:e,storage:this.storage})}async getProfiles(){return be({client:this.client,ecosystem:this.ecosystem,storage:this.storage})}}function ze(t,e){throw new Error(`Invalid param: ${t}`)}function Ge(){return typeof window<"u"&&window.localStorage?z:ce}export{Qe as InAppWebConnector};
